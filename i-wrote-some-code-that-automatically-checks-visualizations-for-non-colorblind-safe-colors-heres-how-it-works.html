<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/dd8d3b5be9662933.css" as="style"/><link rel="stylesheet" href="/_next/static/css/dd8d3b5be9662933.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-59c5c889f52620d6.js" defer=""></script><script src="/_next/static/chunks/framework-2c79e2a64abdb08b.js" defer=""></script><script src="/_next/static/chunks/main-f11614d8aa7ee555.js" defer=""></script><script src="/_next/static/chunks/pages/_app-694ee0f2821639fc.js" defer=""></script><script src="/_next/static/chunks/996-eeb5175dbd5dba8f.js" defer=""></script><script src="/_next/static/chunks/36-94b5e24e03efc6db.js" defer=""></script><script src="/_next/static/chunks/pages/%5B...slug%5D-af748dcc13a25fcb.js" defer=""></script><script src="/_next/static/qDg91nRpW1T3K0AfdjzxW/_buildManifest.js" defer=""></script><script src="/_next/static/qDg91nRpW1T3K0AfdjzxW/_ssgManifest.js" defer=""></script></head><body><div id="__next"></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"I wrote some code that automatically checks visualizations for non-colorblind safe colors. Here's how it works\n","link":"https://vis4.net/blog/2018/02/automate-colorblind-checking/","pubDate":"2018-02-08T14:09:30.000Z","content":"\u003cp\u003eEarlier this week we released a new feature at Datawrapper that \u003ca href=\"https://blog.datawrapper.de/colorblind-check/\" target=\"_blank\" rel=\"noopener\"\u003e\u003cstrong\u003echecks colors\u003c/strong\u003e used in charts or maps \u003cstrong\u003efor problems with colorblind readers\u003c/strong\u003e\u003c/a\u003e. If problematic colors are found, a warning sign is shown that leads to a colorblind simulation view that helps our users find better colors.\u003c/p\u003e\u003cp\u003eThis blog post explains how the code works. Perhaps this can open a discussion for future improvement. I also hope that other tools will follow Darawrapper on this path towards more automated accessibility testing.\u003c/p\u003e\u003cp\u003eTo see how the algorithm work we’ll look at an example map showing population growth in the US between 2000 and 2010, based on \u003ca href=\"https://www.texastribune.org/2011/03/25/maps-visualize-us-population-growth-by-county/\" target=\"_blank\" rel=\"noopener\"\u003ethis map made by Matt Stiles\u003c/a\u003e in 2011:\u003c/p\u003e\u003cdiv class=\"us-map poster poster-945\" style=\"position: relative;\"\u003e\u003c/div\u003e\u003cinput type=\"color\" class=\"map-gradient\" value=\"#E52000\"\u003e\u003cinput type=\"color\" class=\"map-gradient\" value=\"#FFF2C3\"\u003e\u003cinput type=\"color\" class=\"map-gradient\" value=\"#eeeeee\"\u003e\u003cinput type=\"color\" class=\"map-gradient\" value=\"#DEE6D0\"\u003e\u003cinput type=\"color\" class=\"map-gradient\" value=\"#03934C\"\u003e\u003cscript type=\"text/javascript\"\u003efunction makeMap() {    var base = \"/blog/interactives/usmap/\";    d3.loadData(base+'us-counties-10m.json', base+\"popchange.csv\", function(error, res) {        var sel = d3.select('.us-map').html(''),            pad = 10,            margin = {top:0,bottom:0,left:pad,right:pad},            totalWidth = sel.node().clientWidth,            totalHeight = totalWidth * 0.6;        var c = d3.conventions({sel, margin, totalWidth, totalHeight}),            [svg] = c.layers,            proj = d3.geoIdentity(),            path = d3.geoPath().projection(proj);        // read colors from inputs        var colors = [];        d3.selectAll('.map-gradient').each(function() {            colors.push(d3.select(this).prop('value'));        });        var scale = chroma            .scale(colors)            .domain([-50,-1,0,1,60]).out('hex');        var colors = d3.set();        // load data        if (error) throw error;        var [us, popchange] = res;        var popchange = d3.nest()            .key(d3.f('FIPS'))            .rollup(d3.f(0))            .object(popchange);        var nation = topojson.feature(us, us.objects.nation),            counties = topojson.feature(us, us.objects.counties).features;        proj.fitSize([totalWidth-pad*2, totalHeight], nation);        svg.append('g.counties')            .appendMany('path', counties)            .attr('d', path)            .style('fill', function(cty) {                var d = popchange[cty.id] || {},                    col = scale(+d.popchange||0);                colors.add(col);                return col;            });        svg.append(\"path\")            .st({fill:'none', stroke:'white'})            .attr(\"d\", path(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; })));        svg.append(\"path\")            .st({fill:'none',stroke:'black'})            .attr(\"d\", path(nation));        // run the rest of the demos        updateColors(colors);    });}function deltaE(col1, col2) {    return 0.5*(chroma.deltaE(col1,col2)+chroma.deltaE(col2,col1));}d3.selectAll('.map-gradient').on('change', makeMap);\u003c/script\u003e\u003cp\u003eSo here’s what we’re going to do\u003c/p\u003e\u003col\u003e\u003cli\u003eWe need to extract a representative color sample\u003c/li\u003e\u003cli\u003eThen look for color-pairs that are distinguishable under normal vision and\u003c/li\u003e\u003cli\u003echeck if any of them turn indistinguishable in a color blindness simulated view\u003c/li\u003e\u003cli\u003eFinally we need to decide whether or not to show a warning.\u003c/li\u003e\u003c/ol\u003e\u003ch2 id=\"extracting-a-representative-color-sample\"\u003e\u003ca class=\"anchor\" href=\"#extracting-a-representative-color-sample\"\u003e\u003cspan class=\"header-anchor\"\u003e#\u003c/span\u003e\u003c/a\u003e Extracting a representative color sample\u003c/h2\u003e\u003cp\u003eNow, to check if this map is colorblind-friendly or not, we need to look at the colors used in it. In some graphics there might be just a handful of colors, but since this is a continuous US county choropleth map, we have a lot of them (\u003cstrong\u003e\u003cspan class=\"num-colors\"\u003eTK\u003c/span\u003e\u003c/strong\u003e, to be exact).\u003c/p\u003e\u003cdiv class=\"all-colors colors\"\u003e\u003c/div\u003e\u003cp\u003eSince the next step will involve checking each combination of these colors, it would result in a lot of permutations (\u003cstrong\u003e\u003cspan class=\"num-pairs\"\u003eTK\u003c/span\u003e\u003c/strong\u003e, to be exact). So in order to save some work we need to reduce the number of colors.\u003c/p\u003e\u003cp\u003eMy first approach was to use \u003cstrong\u003erandom sampling\u003c/strong\u003e. To illustrate this, let’s look at 20 random colors from the palette above:\u003c/p\u003e\u003cdiv class=\"random-colors colors large\"\u003e\u003c/div\u003e\u003cp\u003eThis might look like a nice sample at first glance, but due to the is random sampling we might end up with more colors from either spectrum of the palette. Click the button below to try a few more samples.\u003c/p\u003e\u003cp\u003e\u003cbutton class=\"resample-random\"\u003eRepeat random sampling\u003c/button\u003e\u003c/p\u003e\u003cp\u003eTo get around this problem I tried to find a more deterministic sampling method that gives us a representative collection of colors. Since color blindness affects hue perception I thought it made sense to get a good sample of the entire hue-spectrum. So I sorted all colors by hue…\u003c/p\u003e\u003cdiv class=\"all-colors-sorted colors\"\u003e\u003c/div\u003e\u003cp\u003e…and then pick 20 evenly spaced colors along this spectrum. Like taking a sample every 5th percentile. To deal with interpolation (in case a percentile falls exactly between two colors) I used the \u003ca href=\"https://gka.github.io/chroma.js/#scale-colors\" target=\"_blank\" rel=\"noopener\"\u003escale.colors()\u003c/a\u003e method in chroma.js.\u003c/p\u003e\u003cfigure class=\"highlight js\"\u003e\u003ctable\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003evar\u003c/span\u003e sample = chroma.scale(sorted_colors).colors(\u003cspan class=\"number\"\u003e20\u003c/span\u003e);\u003c/span\u003e\u003cbr\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\u003c/figure\u003e\u003cp\u003eAnd this is what the sample looks like:\u003c/p\u003e\u003cdiv class=\"hue-sample colors large\"\u003e\u003c/div\u003e\u003cscript type=\"text/javascript\"\u003efunction updateColors(colors) {    d3.select('.all-colors').html('')        .appendMany('div.color', colors.values())        .st('background', d3.f());    var numColors = colors.size();    // update color counts    d3.select('.num-colors').text(numColors);    d3.select('.num-pairs').text(d3.format(',')((numColors * (numColors-1))/2));    // update random sample    randomSample();    hueSample();    d3.select('.resample-random').on('click', randomSample);    // random sampling    function randomSample() {        var sample = _.sample(colors.values(), 20);;        d3.select('.random-colors').html('')            .appendMany('div.color', sample)            .st('background', d3.f());    }    // hue sorted percentiles    function hueSample() {        var sorted = colors.values().sort(d3.ascendingKey(function(col) {            return chroma(col).get('lch.h') || 1000;        }));        // show all sorted colors        d3.select('.all-colors-sorted').html('')            .appendMany('div.color', sorted)            .attr('title', function(c) { return chroma(c).get('lch.h'); })            .st('background', d3.f());        // show sample        var sample = chroma.scale(sorted).colors(20);        d3.select('.hue-sample').html('')            .appendMany('div.color', sample)            .st('background', d3.f())            .attr('title', function(c) { return chroma(c).get('lch.h'); });        // compute distance matrix        colorDistanceMatrix('.cdm-normal', sample);        cbsimTable(sample);    }}\u003c/script\u003e\u003cp\u003eWe could experiment with other sampling methods, but for now these look good enough, so let’s move on. Next we want to find out which of the resulting \u003cstrong\u003e190\u003c/strong\u003e color pairs are actually distinguishable from another. To do that we need to find a method to compute differences between colors.\u003c/p\u003e\u003ch2 id=\"how-to-compute-color-differences\"\u003e\u003ca class=\"anchor\" href=\"#how-to-compute-color-differences\"\u003e\u003cspan class=\"header-anchor\"\u003e#\u003c/span\u003e\u003c/a\u003e How to compute color differences\u003c/h2\u003e\u003cp\u003eThere are a couple of ways to do this. For instance, a color can be represented as three-dimensional coordinates in a \u003cspan style=\"color:red\"\u003eR\u003c/span\u003e-\u003cspan style=\"color:#0c0\"\u003eG\u003c/span\u003e-\u003cspan style=\"color:blue\"\u003eB\u003c/span\u003e color space, so the color difference can be defined as the Euclidean distance between the two points.\u003c/p\u003e\u003cp\u003e\u003cspan class=\"katex-display\"\u003e\u003cspan class=\"katex\"\u003e\u003cspan class=\"katex-mathml\"\u003e\u003cmath\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmi\u003ed\u003c/mi\u003e\u003cmi\u003ei\u003c/mi\u003e\u003cmi\u003es\u003c/mi\u003e\u003cmsub\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmrow\u003e\u003cmi\u003eR\u003c/mi\u003e\u003cmi\u003eG\u003c/mi\u003e\u003cmi\u003eB\u003c/mi\u003e\u003c/mrow\u003e\u003c/msub\u003e\u003cmo\u003e=\u003c/mo\u003e\u003cmsqrt\u003e\u003cmrow\u003e\u003cmo\u003e(\u003c/mo\u003e\u003cmsub\u003e\u003cmi\u003eR\u003c/mi\u003e\u003cmn\u003e2\u003c/mn\u003e\u003c/msub\u003e\u003cmo\u003e−\u003c/mo\u003e\u003cmsub\u003e\u003cmi\u003eR\u003c/mi\u003e\u003cmn\u003e1\u003c/mn\u003e\u003c/msub\u003e\u003cmsup\u003e\u003cmo\u003e)\u003c/mo\u003e\u003cmrow\u003e\u003cmn\u003e2\u003c/mn\u003e\u003c/mrow\u003e\u003c/msup\u003e\u003cmo\u003e+\u003c/mo\u003e\u003cmo\u003e(\u003c/mo\u003e\u003cmsub\u003e\u003cmi\u003eG\u003c/mi\u003e\u003cmn\u003e2\u003c/mn\u003e\u003c/msub\u003e\u003cmo\u003e−\u003c/mo\u003e\u003cmsub\u003e\u003cmi\u003eG\u003c/mi\u003e\u003cmn\u003e1\u003c/mn\u003e\u003c/msub\u003e\u003cmsup\u003e\u003cmo\u003e)\u003c/mo\u003e\u003cmrow\u003e\u003cmn\u003e2\u003c/mn\u003e\u003c/mrow\u003e\u003c/msup\u003e\u003cmo\u003e+\u003c/mo\u003e\u003cmo\u003e(\u003c/mo\u003e\u003cmsub\u003e\u003cmi\u003eB\u003c/mi\u003e\u003cmn\u003e2\u003c/mn\u003e\u003c/msub\u003e\u003cmo\u003e−\u003c/mo\u003e\u003cmsub\u003e\u003cmi\u003eB\u003c/mi\u003e\u003cmn\u003e1\u003c/mn\u003e\u003c/msub\u003e\u003cmsup\u003e\u003cmo\u003e)\u003c/mo\u003e\u003cmrow\u003e\u003cmn\u003e2\u003c/mn\u003e\u003c/mrow\u003e\u003c/msup\u003e\u003c/mrow\u003e\u003c/msqrt\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003edist_{RGB}=\\sqrt{(R_2-R_1)^{2} + (G_2-G_1)^{2} + (B_2-B_1)^{2}}\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html\" aria-hidden=\"true\"\u003e\u003cspan class=\"strut\" style=\"height:0.9838800000000001em;\"\u003e\u003c/span\u003e\u003cspan class=\"strut bottom\" style=\"height:1.24001em;vertical-align:-0.2561299999999999em;\"\u003e\u003c/span\u003e\u003cspan class=\"base displaystyle textstyle uncramped\"\u003e\u003cspan class=\"mord mathit\"\u003ed\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003ei\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003es\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathit\"\u003et\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0.15em;margin-right:0.05em;margin-left:0em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord scriptstyle cramped\"\u003e\u003cspan class=\"mord mathit\" style=\"margin-right:0.00773em;\"\u003eR\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003eG\u003c/span\u003e\u003cspan class=\"mord mathit\" style=\"margin-right:0.05017em;\"\u003eB\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mrel\"\u003e=\u003c/span\u003e\u003cspan class=\"sqrt mord\"\u003e\u003cspan class=\"sqrt-sign\" style=\"top:-0.09388000000000007em;\"\u003e\u003cspan class=\"style-wrap reset-textstyle textstyle uncramped\"\u003e\u003cspan class=\"delimsizing size1\"\u003e√\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:1em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mord displaystyle textstyle cramped\"\u003e\u003cspan class=\"mopen\"\u003e(\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathit\" style=\"margin-right:0.00773em;\"\u003eR\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0.15em;margin-right:0.05em;margin-left:-0.00773em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord mathrm\"\u003e2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mbin\"\u003e−\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathit\" style=\"margin-right:0.00773em;\"\u003eR\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0.15em;margin-right:0.05em;margin-left:-0.00773em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord mathrm\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mclose\"\u003e\u003cspan class=\"mclose\"\u003e)\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:-0.289em;margin-right:0.05em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord scriptstyle cramped\"\u003e\u003cspan class=\"mord mathrm\"\u003e2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mbin\"\u003e+\u003c/span\u003e\u003cspan class=\"mopen\"\u003e(\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathit\"\u003eG\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0.15em;margin-right:0.05em;margin-left:0em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord mathrm\"\u003e2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mbin\"\u003e−\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathit\"\u003eG\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0.15em;margin-right:0.05em;margin-left:0em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord mathrm\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mclose\"\u003e\u003cspan class=\"mclose\"\u003e)\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:-0.289em;margin-right:0.05em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord scriptstyle cramped\"\u003e\u003cspan class=\"mord mathrm\"\u003e2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mbin\"\u003e+\u003c/span\u003e\u003cspan class=\"mopen\"\u003e(\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathit\" style=\"margin-right:0.05017em;\"\u003eB\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0.15em;margin-right:0.05em;margin-left:-0.05017em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord mathrm\"\u003e2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mbin\"\u003e−\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathit\" style=\"margin-right:0.05017em;\"\u003eB\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0.15em;margin-right:0.05em;margin-left:-0.05017em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord mathrm\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mclose\"\u003e\u003cspan class=\"mclose\"\u003e)\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:-0.289em;margin-right:0.05em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord scriptstyle cramped\"\u003e\u003cspan class=\"mord mathrm\"\u003e2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"top:-0.90388em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:1em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle textstyle uncramped sqrt-line\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:1em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/p\u003e\u003cp\u003eHowever, after playing around with RGB distances a bit I noticed a problem: Look at the yellow/green and pink/blue combinations below. From eyeballing the colors I had expected the distance between yellow and green to be smaller than the pink/blue combination.\u003c/p\u003e\u003cdiv class=\"colors xlarge\"\u003e    \u003cdiv class=\"color\" style=\"background: #ff0\"\u003e\u003c/div\u003e\u003cdiv class=\"color\" style=\"background: #0f0\"\u003e\u003c/div\u003e\u003c/div\u003e vs \u003cdiv class=\"colors xlarge\"\u003e    \u003cdiv class=\"color\" style=\"background: #f0f\"\u003e\u003c/div\u003e\u003cdiv class=\"color\" style=\"background: #00f\"\u003e\u003c/div\u003e\u003c/div\u003e\u003cp\u003eBut it turns out, in RGB the distance is exactly 255 in both cases. This makes sense mathematically, since it takes 255 “steps” from \u003cspan style=\"border-bottom:2px solid rgb(255,255,0)\"\u003e(255,255,0)\u003c/span\u003e to \u003cspan style=\"border-bottom:2px solid rgb(0,255,0)\"\u003e(0,255,0)\u003c/span\u003e as well as from \u003cspan style=\"border-bottom:2px solid rgb(255,0,255)\"\u003e(255,0,255)\u003c/span\u003e to \u003cspan style=\"border-bottom:2px solid rgb(0,0,255)\"\u003e(0,0,255)\u003c/span\u003e. But it doesn’t make sense visually.\u003c/p\u003e\u003cp\u003eOf course, the same Euclidean distances can be computed in any other color space, so perhaps a perceptual color space like \u003ccode\u003eLab\u003c/code\u003e or \u003ccode\u003eLch\u003c/code\u003e makes more sense. Sadly, that’s not the case.\u003c/p\u003e\u003ctable style=\"max-width: 350px\"\u003e    \u003ctr\u003e\u003cth\u003e\u003c/th\u003e\u003cth\u003eRGB\u003c/th\u003e\u003cth\u003eLch\u003c/th\u003e\u003cth\u003eLab\u003c/th\u003e\u003cth\u003edeltaE\u003c/th\u003e\u003c/tr\u003e    \u003ctr\u003e        \u003ctd\u003e\u003cdiv class=\"colors xlarge\"\u003e        \u003cdiv class=\"color\" style=\"background: #ff0\"\u003e\u003c/div\u003e\u003cdiv class=\"color\" style=\"background: #0f0\"\u003e\u003c/div\u003e\u003c/div\u003e\u003c/td\u003e        \u003ctd\u003e255\u003c/td\u003e\u003ctd\u003e41.4\u003c/td\u003e\u003ctd\u003e66.3\u003c/td\u003e\u003ctd\u003e26.9\u003c/td\u003e    \u003c/tr\u003e    \u003ctr\u003e        \u003ctd\u003e\u003cdiv class=\"colors xlarge\"\u003e        \u003cdiv class=\"color\" style=\"background: #f0f\"\u003e\u003c/div\u003e\u003cdiv class=\"color\" style=\"background: #00f\"\u003e\u003c/div\u003e\u003c/div\u003e\u003c/td\u003e        \u003ctd\u003e255\u003c/td\u003e\u003ctd\u003e40.0\u003c/td\u003e\u003ctd\u003e58.0\u003c/td\u003e\u003ctd\u003e34.7\u003c/td\u003e    \u003c/tr\u003e\u003c/table\u003e\u003cp\u003eIn Lch, like RGB, both color pairs are almost equally distant. In Lab, the distance between yellow and green is even larger (66.3) than pink/blue (58.0).\u003c/p\u003e\u003cp\u003eSo I ended up using a more fancy algorithm called \u003ca href=\"https://en.wikipedia.org/wiki/Color_difference#CMC_l:c_.281984.29\" target=\"_blank\" rel=\"noopener\"\u003e\u003cstrong\u003edeltaE\u003c/strong\u003e or CMC l:c\u003c/a\u003e. It’s based on the Lch color model, but appears to work better.\u003c/p\u003e\u003cp\u003eOne minor problem with deltaE is that it’s not symmetrical, meaning that the difference between yellow and green differs slightly from the difference between green and yellow. To get around this problem I am using the mean of the distances in both direction:\u003c/p\u003e\u003cp\u003e\u003cspan class=\"katex-display\"\u003e\u003cspan class=\"katex\"\u003e\u003cspan class=\"katex-mathml\"\u003e\u003cmath\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmi\u003ed\u003c/mi\u003e\u003cmi\u003ei\u003c/mi\u003e\u003cmi\u003es\u003c/mi\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmo\u003e(\u003c/mo\u003e\u003cmsub\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmrow\u003e\u003cmn\u003e1\u003c/mn\u003e\u003c/mrow\u003e\u003c/msub\u003e\u003cmo separator=\"true\"\u003e,\u003c/mo\u003e\u003cmsub\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmrow\u003e\u003cmn\u003e2\u003c/mn\u003e\u003c/mrow\u003e\u003c/msub\u003e\u003cmo\u003e)\u003c/mo\u003e\u003cmo\u003e=\u003c/mo\u003e\u003cmfrac\u003e\u003cmrow\u003e\u003cmi\u003ed\u003c/mi\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmi\u003el\u003c/mi\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmi\u003ea\u003c/mi\u003e\u003cmi\u003eE\u003c/mi\u003e\u003cmo\u003e(\u003c/mo\u003e\u003cmsub\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmrow\u003e\u003cmn\u003e1\u003c/mn\u003e\u003c/mrow\u003e\u003c/msub\u003e\u003cmo separator=\"true\"\u003e,\u003c/mo\u003e\u003cmsub\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmrow\u003e\u003cmn\u003e2\u003c/mn\u003e\u003c/mrow\u003e\u003c/msub\u003e\u003cmo\u003e)\u003c/mo\u003e\u003cmo\u003e+\u003c/mo\u003e\u003cmi\u003ed\u003c/mi\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmi\u003el\u003c/mi\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmi\u003ea\u003c/mi\u003e\u003cmi\u003eE\u003c/mi\u003e\u003cmo\u003e(\u003c/mo\u003e\u003cmsub\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmrow\u003e\u003cmn\u003e2\u003c/mn\u003e\u003c/mrow\u003e\u003c/msub\u003e\u003cmo separator=\"true\"\u003e,\u003c/mo\u003e\u003cmsub\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmrow\u003e\u003cmn\u003e1\u003c/mn\u003e\u003c/mrow\u003e\u003c/msub\u003e\u003cmo\u003e)\u003c/mo\u003e\u003c/mrow\u003e\u003cmrow\u003e\u003cmn\u003e2\u003c/mn\u003e\u003c/mrow\u003e\u003c/mfrac\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003edist(c_{1},c_{2})=\\frac{deltaE(c_{1}, c_{2}) + deltaE(c_{2}, c_{1})}{2}\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html\" aria-hidden=\"true\"\u003e\u003cspan class=\"strut\" style=\"height:1.427em;\"\u003e\u003c/span\u003e\u003cspan class=\"strut bottom\" style=\"height:2.113em;vertical-align:-0.686em;\"\u003e\u003c/span\u003e\u003cspan class=\"base displaystyle textstyle uncramped\"\u003e\u003cspan class=\"mord mathit\"\u003ed\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003ei\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003es\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003et\u003c/span\u003e\u003cspan class=\"mopen\"\u003e(\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathit\"\u003ec\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0.15em;margin-right:0.05em;margin-left:0em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord scriptstyle cramped\"\u003e\u003cspan class=\"mord mathrm\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mpunct\"\u003e,\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathit\"\u003ec\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0.15em;margin-right:0.05em;margin-left:0em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord scriptstyle cramped\"\u003e\u003cspan class=\"mord mathrm\"\u003e2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mclose\"\u003e)\u003c/span\u003e\u003cspan class=\"mrel\"\u003e=\u003c/span\u003e\u003cspan class=\"mord reset-textstyle displaystyle textstyle uncramped\"\u003e\u003cspan class=\"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter\"\u003e\u003c/span\u003e\u003cspan class=\"mfrac\"\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0.686em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle textstyle cramped\"\u003e\u003cspan class=\"mord textstyle cramped\"\u003e\u003cspan class=\"mord mathrm\"\u003e2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"top:-0.22999999999999998em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle textstyle uncramped frac-line\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"top:-0.677em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle textstyle uncramped\"\u003e\u003cspan class=\"mord textstyle uncramped\"\u003e\u003cspan class=\"mord mathit\"\u003ed\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003ee\u003c/span\u003e\u003cspan class=\"mord mathit\" style=\"margin-right:0.01968em;\"\u003el\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003et\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003ea\u003c/span\u003e\u003cspan class=\"mord mathit\" style=\"margin-right:0.05764em;\"\u003eE\u003c/span\u003e\u003cspan class=\"mopen\"\u003e(\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathit\"\u003ec\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0.15em;margin-right:0.05em;margin-left:0em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord scriptstyle cramped\"\u003e\u003cspan class=\"mord mathrm\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mpunct\"\u003e,\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathit\"\u003ec\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0.15em;margin-right:0.05em;margin-left:0em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord scriptstyle cramped\"\u003e\u003cspan class=\"mord mathrm\"\u003e2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mclose\"\u003e)\u003c/span\u003e\u003cspan class=\"mbin\"\u003e+\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003ed\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003ee\u003c/span\u003e\u003cspan class=\"mord mathit\" style=\"margin-right:0.01968em;\"\u003el\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003et\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003ea\u003c/span\u003e\u003cspan class=\"mord mathit\" style=\"margin-right:0.05764em;\"\u003eE\u003c/span\u003e\u003cspan class=\"mopen\"\u003e(\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathit\"\u003ec\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0.15em;margin-right:0.05em;margin-left:0em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord scriptstyle cramped\"\u003e\u003cspan class=\"mord mathrm\"\u003e2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mpunct\"\u003e,\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathit\"\u003ec\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0.15em;margin-right:0.05em;margin-left:0em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord scriptstyle cramped\"\u003e\u003cspan class=\"mord mathrm\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mclose\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter\"\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/p\u003e\u003cp\u003eNow let’s move from the difference between two colors to the difference between \u003cem\u003eall\u003c/em\u003e the colors!\u003c/p\u003e\u003ch2 id=\"compute-the-color-distance-matrix\"\u003e\u003ca class=\"anchor\" href=\"#compute-the-color-distance-matrix\"\u003e\u003cspan class=\"header-anchor\"\u003e#\u003c/span\u003e\u003c/a\u003e Compute the color distance matrix\u003c/h2\u003e\u003cp\u003eTo do that we compute the color distance matrix. Which is a fancy word for a table with rows and columns for each of our sample colors, and the distance between each color combination shown in the table cells.\u003c/p\u003e\u003ctable class=\"color-distance-matrix cdm-normal\"\u003e\u003c/table\u003e\u003cscript type=\"text/javascript\"\u003efunction colorDistanceMatrix(cont, sample, baseline) {    var hm = chroma.scale(['#eee','#ddd', '#666']).domain(baseline ? [1,3,10] :[0,10,70]).out('hex');    var table = d3.select(cont).html('');    var tr = table.append('tr');    if (baseline) {        tr.append('td');        tr.append('td');        tr.appendMany('th.color', baseline).st('background', d3.f());        tr = table.append('tr');        tr.append('td');    }    tr.append('td');    tr.appendMany('th.color', sample).st('background', d3.f());    tr = table.appendMany('tr', sample);    if (baseline) {        tr.append('th.color').st('background', (d,i) =\u003e baseline[i]);    }    tr.append('th.color').st('background', d3.f());    tr.appendMany('td', function(a, ia) {            return sample.map(function(b, ib) {                var diff = deltaE(a,b);                return {                    a, ia, b, ib,                    diff: baseline ?                        // difference ratio                        (deltaE(baseline[ia],baseline[ib])/diff).toFixed(1)                        : diff.toFixed(0)                };            });        })        .style('background-color', d3.f('diff', hm))        .text(d3.f('diff'))        .classed('relevant', (d) =\u003e d.ib \u003e d.ia \u0026\u0026 d.diff \u003e= (baseline ? 2 : 8))        .classed('strong', (d) =\u003e d.diff \u003e= (baseline ? 5 : 40))        .classed('lower', (d) =\u003e d.ib \u003c= d.ia);}\u003c/script\u003e\u003cp\u003eWe only need to look at the upper half of the matrix – the lower half is just an exact mirror. I highlighted all values above 45 so the combinations with the largest color differences pop out a bit more.\u003c/p\u003e\u003cp\u003eNow we need to compute the same matrix with the colorblind-simulated versions of our colors.\u003c/p\u003e\u003ch2 id=\"simulating-color-blindness\"\u003e\u003ca class=\"anchor\" href=\"#simulating-color-blindness\"\u003e\u003cspan class=\"header-anchor\"\u003e#\u003c/span\u003e\u003c/a\u003e Simulating color blindness\u003c/h2\u003e\u003cp\u003eColor blindness simulation is done by mapping colors from RGB to a reduced color space. It means that you have a function that gets one color as input and returns a new color.\u003c/p\u003e\u003cp\u003eAfter googling around a bit I settled on a NPM package \u003ca href=\"https://www.npmjs.com/package/color-blind\" target=\"_blank\" rel=\"noopener\"\u003ecolor-blind\u003c/a\u003e, which provides a fairly simple API:\u003c/p\u003e\u003cfigure class=\"highlight js\"\u003e\u003ctable\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003evar\u003c/span\u003e blinder = \u003cspan class=\"built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"string\"\u003e'color-blind'\u003c/span\u003e);\u003c/span\u003e\u003cbr\u003e\u003cspan class=\"line\"\u003eblinder.protanopia(\u003cspan class=\"string\"\u003e'#42dead'\u003c/span\u003e); \u003cspan class=\"comment\"\u003e// result: \"#d1c4a0\"\u003c/span\u003e\u003c/span\u003e\u003cbr\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\u003c/figure\u003e\u003cp\u003eHere is our color sample mapped through three kinds of color blindness:\u003c/p\u003e\u003ctable class=\"simulated\"\u003e\u003c/table\u003e\u003cscript type=\"text/javascript\"\u003efunction cbsimTable(sample) {    var table = d3.select('.simulated').html('');    var tr = table.appendMany('tr', ['normal','deuteranopia','protanopia','tritanopia']);    tr.append('td').append('b').text(d3.f());    var div = tr.append('td').append('div.colors.large');    div.appendMany('div.color', function(t) {            return t == 'normal' ? sample :                sample.map(function(c) { return blinder[t](c); })        })        .style('background', d3.f());    simColorMatrix(sample);    simColorRatioMatrix(sample);    summaryTable(sample);}\u003c/script\u003e\u003cp\u003eNow we can just repeat the color difference matrix for the converted sample colors:\u003c/p\u003e\u003ctable class=\"color-distance-matrix cdm-sim\"\u003e\u003c/table\u003e\u003cp\u003eYou can click through the buttons below to see the color difference matrix for each color blindness simulation:\u003c/p\u003e\u003cdiv class=\"btn-group select-simulation\"\u003e    \u003cbutton\u003enormal\u003c/button\u003e    \u003cbutton class=\"selected\"\u003edeuteranopia\u003c/button\u003e    \u003cbutton\u003eprotanopia\u003c/button\u003e    \u003cbutton\u003etritanopia\u003c/button\u003e\u003c/div\u003e\u003cscript type=\"text/javascript\"\u003efunction simColorMatrix(sample) {    var btns = d3.selectAll('.select-simulation button'),        typ = d3.select('.select-simulation button.selected').text();    btns.on('click.vis4', function() {        btns.classed('selected', false);        d3.select(this).classed('selected', true);        simColorMatrix(sample);    });    var colors = typ == 'normal' ? sample :        sample.map(function(c) { return blinder[typ](c); });    colorDistanceMatrix('.cdm-sim', colors);}\u003c/script\u003e\u003ch2 id=\"computing-difference-ratios-between-normal-and-colorblind-vision\"\u003e\u003ca class=\"anchor\" href=\"#computing-difference-ratios-between-normal-and-colorblind-vision\"\u003e\u003cspan class=\"header-anchor\"\u003e#\u003c/span\u003e\u003c/a\u003e Computing difference ratios between normal and colorblind vision\u003c/h2\u003e\u003cp\u003eWe’re getting closer to the finish line! The only thing that’s left to do now is to \u003cstrong\u003ecompare the differences\u003c/strong\u003e under normal vision with the differences under a color blindness simulation.\u003c/p\u003e\u003cp\u003eOne way to do this is to look at the ratio between the two differences:\u003c/p\u003e\u003cp\u003e\u003cspan class=\"katex-display\"\u003e\u003cspan class=\"katex\"\u003e\u003cspan class=\"katex-mathml\"\u003e\u003cmath\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmi\u003er\u003c/mi\u003e\u003cmi\u003ea\u003c/mi\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmi\u003ei\u003c/mi\u003e\u003cmi\u003eo\u003c/mi\u003e\u003cmo\u003e(\u003c/mo\u003e\u003cmsub\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmn\u003e1\u003c/mn\u003e\u003c/msub\u003e\u003cmo separator=\"true\"\u003e,\u003c/mo\u003e\u003cmsub\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmn\u003e2\u003c/mn\u003e\u003c/msub\u003e\u003cmo\u003e)\u003c/mo\u003e\u003cmo\u003e=\u003c/mo\u003e\u003cmfrac\u003e\u003cmrow\u003e\u003cmi\u003ed\u003c/mi\u003e\u003cmi\u003ei\u003c/mi\u003e\u003cmi\u003es\u003c/mi\u003e\u003cmsub\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmrow\u003e\u003cmi\u003en\u003c/mi\u003e\u003cmi\u003eo\u003c/mi\u003e\u003cmi\u003er\u003c/mi\u003e\u003cmi\u003em\u003c/mi\u003e\u003cmi\u003ea\u003c/mi\u003e\u003cmi\u003el\u003c/mi\u003e\u003c/mrow\u003e\u003c/msub\u003e\u003cmo\u003e(\u003c/mo\u003e\u003cmsub\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmn\u003e1\u003c/mn\u003e\u003c/msub\u003e\u003cmo separator=\"true\"\u003e,\u003c/mo\u003e\u003cmsub\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmn\u003e2\u003c/mn\u003e\u003c/msub\u003e\u003cmo\u003e)\u003c/mo\u003e\u003c/mrow\u003e\u003cmrow\u003e\u003cmi\u003ed\u003c/mi\u003e\u003cmi\u003ei\u003c/mi\u003e\u003cmi\u003es\u003c/mi\u003e\u003cmsub\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmrow\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmi\u003eo\u003c/mi\u003e\u003cmi\u003el\u003c/mi\u003e\u003cmi\u003eo\u003c/mi\u003e\u003cmi\u003er\u003c/mi\u003e\u003cmi\u003eb\u003c/mi\u003e\u003cmi\u003el\u003c/mi\u003e\u003cmi\u003ei\u003c/mi\u003e\u003cmi\u003en\u003c/mi\u003e\u003cmi\u003ed\u003c/mi\u003e\u003c/mrow\u003e\u003c/msub\u003e\u003cmo\u003e(\u003c/mo\u003e\u003cmsub\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmn\u003e1\u003c/mn\u003e\u003c/msub\u003e\u003cmo separator=\"true\"\u003e,\u003c/mo\u003e\u003cmsub\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmn\u003e2\u003c/mn\u003e\u003c/msub\u003e\u003cmo\u003e)\u003c/mo\u003e\u003c/mrow\u003e\u003c/mfrac\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003eratio(c_1,c_2)=\\frac{dist_{normal}(c_1,c_2)}{dist_{colorblind}(c_1,c_2)}\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html\" aria-hidden=\"true\"\u003e\u003cspan class=\"strut\" style=\"height:1.427em;\"\u003e\u003c/span\u003e\u003cspan class=\"strut bottom\" style=\"height:2.363em;vertical-align:-0.936em;\"\u003e\u003c/span\u003e\u003cspan class=\"base displaystyle textstyle uncramped\"\u003e\u003cspan class=\"mord mathit\" style=\"margin-right:0.02778em;\"\u003er\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003ea\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003et\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003ei\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003eo\u003c/span\u003e\u003cspan class=\"mopen\"\u003e(\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathit\"\u003ec\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0.15em;margin-right:0.05em;margin-left:0em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord mathrm\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mpunct\"\u003e,\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathit\"\u003ec\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0.15em;margin-right:0.05em;margin-left:0em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord mathrm\"\u003e2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mclose\"\u003e)\u003c/span\u003e\u003cspan class=\"mrel\"\u003e=\u003c/span\u003e\u003cspan class=\"mord reset-textstyle displaystyle textstyle uncramped\"\u003e\u003cspan class=\"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter\"\u003e\u003c/span\u003e\u003cspan class=\"mfrac\"\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0.686em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle textstyle cramped\"\u003e\u003cspan class=\"mord textstyle cramped\"\u003e\u003cspan class=\"mord mathit\"\u003ed\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003ei\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003es\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathit\"\u003et\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0.15em;margin-right:0.05em;margin-left:0em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord scriptstyle cramped\"\u003e\u003cspan class=\"mord mathit\"\u003ec\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003eo\u003c/span\u003e\u003cspan class=\"mord mathit\" style=\"margin-right:0.01968em;\"\u003el\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003eo\u003c/span\u003e\u003cspan class=\"mord mathit\" style=\"margin-right:0.02778em;\"\u003er\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003eb\u003c/span\u003e\u003cspan class=\"mord mathit\" style=\"margin-right:0.01968em;\"\u003el\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003ei\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003en\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003ed\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mopen\"\u003e(\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathit\"\u003ec\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0.15em;margin-right:0.05em;margin-left:0em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord mathrm\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mpunct\"\u003e,\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathit\"\u003ec\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0.15em;margin-right:0.05em;margin-left:0em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord mathrm\"\u003e2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mclose\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"top:-0.2300000000000001em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle textstyle uncramped frac-line\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"top:-0.677em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle textstyle uncramped\"\u003e\u003cspan class=\"mord textstyle uncramped\"\u003e\u003cspan class=\"mord mathit\"\u003ed\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003ei\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003es\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathit\"\u003et\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0.15em;margin-right:0.05em;margin-left:0em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord scriptstyle cramped\"\u003e\u003cspan class=\"mord mathit\"\u003en\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003eo\u003c/span\u003e\u003cspan class=\"mord mathit\" style=\"margin-right:0.02778em;\"\u003er\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003em\u003c/span\u003e\u003cspan class=\"mord mathit\"\u003ea\u003c/span\u003e\u003cspan class=\"mord mathit\" style=\"margin-right:0.01968em;\"\u003el\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mopen\"\u003e(\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathit\"\u003ec\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0.15em;margin-right:0.05em;margin-left:0em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord mathrm\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mpunct\"\u003e,\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathit\"\u003ec\u003c/span\u003e\u003cspan class=\"vlist\"\u003e\u003cspan style=\"top:0.15em;margin-right:0.05em;margin-left:0em;\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"reset-textstyle scriptstyle cramped\"\u003e\u003cspan class=\"mord mathrm\"\u003e2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mclose\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"baseline-fix\"\u003e\u003cspan class=\"fontsize-ensurer reset-size5 size5\"\u003e\u003cspan style=\"font-size:0em;\"\u003e​\u003c/span\u003e\u003c/span\u003e​\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter\"\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/p\u003e\u003cp\u003eTo illustrate the ratio, let’s look at the notorious \u003cspan style=\"border-bottom:2px solid #54ae49\"\u003egreen\u003c/span\u003e/\u003cspan style=\"border-bottom:2px solid #f06c62\"\u003ered\u003c/span\u003e color pair and compute the differences between them after applying different colorblindness simulations.\u003c/p\u003e\u003ctable class=\"color-ratios\"\u003e\u003c/table\u003e\u003cscript type=\"text/javascript\"\u003efunction colorRatios(col1, col2) {    var table = d3.select('.color-ratios').html('');    var modes = ['normal','deuteranopia','protanopia','tritanopia'];    table.append('tr').appendMany('th', [''].concat(modes)).text(d3.f());    var dist_norm = deltaE(col1,col2);    var columns = modes.map(function(mode) {        var c1 = mode == 'normal' ? col1 : blinder[mode](col1);        var c2 = mode == 'normal' ? col2 : blinder[mode](col2);        var dist = deltaE(c1,c2);        return {            mode: mode,            colors: [c1,c2],            distance: dist,            ratio: dist_norm.toFixed()+'/'+dist.toFixed()+' = \u003cb\u003e'+ (dist_norm / dist).toFixed(1)+'\u003c/b\u003e'        };    });    // colors    var tr = table.append('tr');    tr.append('td').text('Colors');    tr.appendMany('td.color', columns)        .append('div.colors.xlarge')        .appendMany('div.color', (col) =\u003e col.colors)        .style('background', d3.f());    // distance    tr = table.append('tr');    tr.append('td').text('Distance');    tr.appendMany('td', columns)        .text((col) =\u003e col.distance.toFixed(0));    // ratio    tr = table.append('tr');    tr.append('td').text('Ratio').style('font-weight','bold');    tr.appendMany('td', columns)        .html((col) =\u003e col.ratio);}colorRatios('#54ae49', '#f06c62');\u003c/script\u003e\u003cp\u003eA ratio of 17.3 means that a color pair is \u003cstrong\u003eseventeen times more differentiable\u003c/strong\u003e under normal vision than under this type of color blindness. The higher the ratio the more information is “lost” for a colorblind person. This is what we’ll use to decide what colors are ok or not.\u003c/p\u003e\u003cp\u003eNow, to \u003cstrong\u003elook at all the ratios at once\u003c/strong\u003e, let’s make another matrix. The table looks just like the matrices we’ve seen before, except now the values in the cells show the ratio between the normal distance and the colorblind distance for each color pair.\u003c/p\u003e\u003ctable class=\"color-distance-matrix cdm-sim-ratios\"\u003e\u003c/table\u003e\u003cdiv class=\"btn-group select-simulation2\"\u003e    \u003cbutton\u003enormal\u003c/button\u003e    \u003cbutton\u003edeuteranopia\u003c/button\u003e    \u003cbutton class=\"selected\"\u003eprotanopia\u003c/button\u003e    \u003cbutton\u003etritanopia\u003c/button\u003e\u003c/div\u003e\u003cscript type=\"text/javascript\"\u003efunction simColorRatioMatrix(sample) {    var btns = d3.selectAll('.select-simulation2 button'),        typ = d3.select('.select-simulation2 button.selected').text();    btns.on('click.vis4', function() {        btns.classed('selected', false);        d3.select(this).classed('selected', true);        simColorRatioMatrix(sample);    });    var colors = typ == 'normal' ? sample :        sample.map(function(c) { return blinder[typ](c); });    colorDistanceMatrix('.cdm-sim-ratios', colors, sample);}\u003c/script\u003e\u003cp\u003eYou can use the buttons to cycle through the different simulations.\u003c/p\u003e\u003cp\u003eAll that’s left to do now is to decide when to show a warning.\u003c/p\u003e\u003ch2 id=\"when-to-show-a-color-warning\"\u003e\u003ca class=\"anchor\" href=\"#when-to-show-a-color-warning\"\u003e\u003cspan class=\"header-anchor\"\u003e#\u003c/span\u003e\u003c/a\u003e When to show a color warning\u003c/h2\u003e\u003cp\u003eOne criteria to check for I came up with is to check how many of the color pairs that were differentiable under normal vision turn into non-differentiable color pairs under colorblind vision. I also found that difference ratios above five signal a significant loss of information. So I ended up using a mix of both to decide when to trigger warnings.\u003c/p\u003e\u003cp\u003eAs you can see in the table, it all depends highly on where I set the thresholds. You can tweak the sliders below to change them and see the results changing.\u003c/p\u003e\u003ctable class=\"summary\"\u003e\u003c/table\u003e\u003cdiv class=\"summary-ctrls\"\u003e    \u003clabel\u003eDifference threshold: \u003cb class=\"diff-thresh\"\u003e\u003c/b\u003e\u003cbr\u003e\u003cinput class=\"diff-input\" type=\"range\" value=\"5\" min=\"4\" max=\"20\" step=\"0.1\"\u003e\u003c/label\u003e    \u003clabel\u003eRatio threshold: \u003cb class=\"ratio-thresh\"\u003e\u003c/b\u003e\u003cbr\u003e\u003cinput class=\"ratio-input\" type=\"range\" value=\"5\" min=\"1\" max=\"10\" step=\"0.1\"\u003e\u003c/label\u003e    \u003clabel\u003eWarning threshold: \u003cb class=\"warning-thresh\"\u003e\u003c/b\u003e%\u003cbr\u003e\u003cinput class=\"warning-input\" type=\"range\" value=\"4\" min=\"0.1\" max=\"40\" step=\"0.1\"\u003e\u003c/label\u003e\u003c/div\u003e\u003cscript type=\"text/javascript\"\u003e    function summaryTable(colors) {        d3.selectAll('.summary-ctrls input').on('input', function() {            summaryTable(colors);        });        var ratio_thresh = +d3.select('.ratio-input').prop('value');        var diff_thresh = +d3.select('.diff-input').prop('value');        var warning_thresh = +d3.select('.warning-input').prop('value');        console.log('rrr', ratio_thresh, ratio_thresh.toFixed(1));        d3.select('.ratio-thresh').html(ratio_thresh.toFixed(1));        d3.select('.diff-thresh').html(diff_thresh.toFixed(1));        d3.select('.warning-thresh').html(warning_thresh.toFixed(1));        var table = d3.select('.summary').html('');        var modes = ['normal', 'deuteranopia','protanopia','tritanopia'];        table.append('tr').appendMany('th', [''].concat(modes)).text(d3.f());        var num_colors = colors.length,            num_perm = (colors.length*(colors.length-1))/2;        // var dist_ratio = (chroma.deltaE(col1,col2)+chroma.deltaE(col2,col1))*0.5;        var columns = modes.map(function(mode) {            // var c1 = mode == 'normal' ? col1 : blinder[mode](col1);            // var c2 = mode == 'normal' ? col2 : blinder[mode](col2);            // var dist = (chroma.deltaE(c1,c2)+chroma.deltaE(c2,c1))*0.5;            var diff_colors = 0,                cnt_ratio = 0,                cnt_sim_diff = 0,                max_ratio = 0,                sum_ratio = 0;            colors.forEach((col_a, i) =\u003e {                colors.forEach((col_b, j) =\u003e {                    if (j\u003ei) {                        var dist_norm = deltaE(col_a, col_b);                        if (dist_norm \u003e= diff_thresh) {                            diff_colors++;                            if (mode != 'normal') {                                var sim_a = blinder[mode](col_a),                                    sim_b = blinder[mode](col_b);                                var dist_sim = deltaE(sim_a, sim_b);                                if (dist_sim \u003c diff_thresh) {                                    cnt_sim_diff++;                                }                                var ratio = dist_norm / dist_sim;                                sum_ratio+= ratio;                                if (ratio \u003e max_ratio) max_ratio = ratio;                                if (ratio \u003e= ratio_thresh) cnt_ratio++;                            }                        }                    }                });            });            var ratio_pct = 100*(cnt_ratio/diff_colors);            var diff_pct = 100*(cnt_sim_diff/diff_colors);            return {                mode: mode,                colors: mode == 'normal' ? num_colors : '-',                permutations: mode == 'normal' ? num_perm : '-',                differentiable: mode == 'normal' ? diff_colors : '-',                sim_not_diff: mode == 'normal' ? '' : cnt_sim_diff + ' ('+diff_pct.toFixed(1)+'%)',                ratio: mode == 'normal' ? '' : cnt_ratio+' ('+ratio_pct.toFixed(1)+'%)',                ratio_avg: mode == 'normal' ? '' : (sum_ratio / diff_colors).toFixed(1),                ratio_max: mode == 'normal' ? '' : (max_ratio).toFixed(1),                warning: mode== 'normal' ? '' : ratio_pct \u003e= warning_thresh || diff_pct \u003e warning_thresh ? '\u003cb\u003eWARNING\u003c/b\u003e' : 'ok'                // colors: [c1,c2],                // distance: dist,                // ratio: dist_norm / dist            };        });        // number of colors        var tr = table.append('tr');        tr.append('td').text('Colors');        tr.appendMany('td', columns).text(d3.f('colors'));        // number of color permutations        tr = table.append('tr');        tr.append('td').text('Color pairs');        tr.appendMany('td', columns).text(d3.f('permutations'));        // of those, differentiable        tr = table.append('tr');        tr.append('td').html('Differentiable color pairs');        tr.appendMany('td', columns).text(d3.f('differentiable'));        // hr        // tr = table.append('tr');        // tr.append('td').attr('colspan', 4)        //     .st({textAlign:'center', color: '#999'})        //     .text('of those...');        // non differentiable        tr = table.append('tr');        tr.append('td').html('..that turn into non-differentiable\u003cbr\u003epairs under colorblind simulation');        tr.appendMany('td', columns).text(d3.f('sim_not_diff'));        // of those, differentiable        // tr = table.append('tr');        // tr.append('td').text('Avg. ratio');        // tr.appendMany('td', columns).text(d3.f('ratio_avg'));        // // of those, differentiable        // tr = table.append('tr');        // tr.append('td').text('Max. ratio');        // tr.appendMany('td', columns).text(d3.f('ratio_max'));        // of those, differentiable        tr = table.append('tr');        tr.append('td').text('Ratio \u003e '+(ratio_thresh.toFixed(1)));        tr.appendMany('td', columns).text(d3.f('ratio'));        // of those, differentiable        tr = table.append('tr');        tr.append('td').text('Result');        tr.appendMany('td', columns).html(d3.f('warning'));        // of those, differentiable    }\u003c/script\u003e\u003cp\u003eFeel free to scroll back to the top and try out different colors in the map. All the examples and matrices in this post will change accordingly. Let me know if you find bugs along the way.\u003c/p\u003e\u003ch2 id=\"some-ideas-for-future-improvements\"\u003e\u003ca class=\"anchor\" href=\"#some-ideas-for-future-improvements\"\u003e\u003cspan class=\"header-anchor\"\u003e#\u003c/span\u003e\u003c/a\u003e Some ideas for future improvements\u003c/h2\u003e\u003cp\u003eThis algorithm was hacked together in a few days, so obviously there are possible improvements to be made. Here are a few ideas that might be worth exploring:\u003c/p\u003e\u003cul\u003e\u003cli\u003eInstead of the hue-percentiles we could try different methods to find the most “representative” colors, such as k-means clustering.\u003c/li\u003e\u003cli\u003eOne could look out for different color difference metrics, ideally by having (non-colorblind) people “guess” color differences and compare these results with the various color difference formulas.\u003c/li\u003e\u003cli\u003eMaybe there are smarter ways to compare the color differences between normal and colorblind vision than looking at the ratios?\u003c/li\u003e\u003cli\u003eMaybe there are smarter ways to decide how many “problematic” colors are enough to trigger the color blindness warning.\u003c/li\u003e\u003cli\u003eClearly, it would help testing a larger set of charts and maps with this algorithm to measure its real performance\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eAs always I’m happy to hear what you think. Feel free to drop a comment below or send me an email at \u003ca href=\"mailto:gregor@datawrapper.de\" target=\"_blank\" rel=\"noopener\"\u003egregor@datawrapper.de\u003c/a\u003e.\u003c/p\u003e\u003cscript type=\"text/javascript\"\u003e    makeMap();\u003c/script\u003e\u003cstyle type=\"text/css\"\u003e    svg,canvas {top:0;}    button { font-size: 15px; padding: 5px 15px;  }    .colors { line-height: 0;  padding: 2px 0 0 2px; display: inline-block;}    .colors .color { box-sizing: border-box; border: 2px solid white; display: inline-block;        width: 16px; height: 16px; margin: -2px 0 0 -2px; }    .colors.large .color { width: 28px; height: 28px;  }    td .colors.large .color { width: 24px; height: 24px;  }    .colors.xlarge .color { width: 38px; height: 38px;  }    .colors.xlarge .color+.color{ border-left: 0 }    .all-colors-sorted { border-left: 2px solid white }    .all-colors-sorted .color{ border-left: 0 }    .content table.color-distance-matrix { cursor:pointer;overflow: hidden; z-index: 1; border-spacing: 0; border-collapse: separate; border: 1px solid white;}    .color-distance-matrix th,    .color-distance-matrix td { border:1px solid white; padding:0; color: #888;}    .color-distance-matrix th { width:16px; height:21px; }    .color-distance-matrix td { font-size: 11px; text-align: center;vertical-align: middle; position: relative;}    .color-distance-matrix tr:hover { background: #e0e0e0 }    .color-distance-matrix td:hover::after {        background-color: #e0e0e0; content: '\\00a0';height: 10000px;left: 0;position: absolute;        top: -5000px;width: 100%;z-index: -1;    }    .summary-ctrls label { display: inline-block; font-size: 14px; margin-right: 15px }    label input[type=range] { vertical-align: middle; margin: 0;}    .color-distance-matrix td:hover { background: #ccc; }    .color-distance-matrix td.relevant { color: #333; }    .color-distance-matrix td.strong { font-weight: bold; color:#fff;}    .color-distance-matrix td.lower { color: #d7d7d7; background: transparent!important;}\u003c/style\u003e","contentSnippet":"Earlier this week we released a new feature at Datawrapper that checks colors used in charts or maps for problems with colorblind readers. If problematic colors are found, a warning sign is shown that leads to a colorblind simulation view that helps our users find better colors.\nThis blog post explains how the code works. Perhaps this can open a discussion for future improvement. I also hope that other tools will follow Darawrapper on this path towards more automated accessibility testing.\nTo see how the algorithm work we’ll look at an example map showing population growth in the US between 2000 and 2010, based on this map made by Matt Stiles in 2011:\n\nfunction makeMap() {    var base = \"/blog/interactives/usmap/\";    d3.loadData(base+'us-counties-10m.json', base+\"popchange.csv\", function(error, res) {        var sel = d3.select('.us-map').html(''),            pad = 10,            margin = {top:0,bottom:0,left:pad,right:pad},            totalWidth = sel.node().clientWidth,            totalHeight = totalWidth * 0.6;        var c = d3.conventions({sel, margin, totalWidth, totalHeight}),            [svg] = c.layers,            proj = d3.geoIdentity(),            path = d3.geoPath().projection(proj);        // read colors from inputs        var colors = [];        d3.selectAll('.map-gradient').each(function() {            colors.push(d3.select(this).prop('value'));        });        var scale = chroma            .scale(colors)            .domain([-50,-1,0,1,60]).out('hex');        var colors = d3.set();        // load data        if (error) throw error;        var [us, popchange] = res;        var popchange = d3.nest()            .key(d3.f('FIPS'))            .rollup(d3.f(0))            .object(popchange);        var nation = topojson.feature(us, us.objects.nation),            counties = topojson.feature(us, us.objects.counties).features;        proj.fitSize([totalWidth-pad*2, totalHeight], nation);        svg.append('g.counties')            .appendMany('path', counties)            .attr('d', path)            .style('fill', function(cty) {                var d = popchange[cty.id] || {},                    col = scale(+d.popchange||0);                colors.add(col);                return col;            });        svg.append(\"path\")            .st({fill:'none', stroke:'white'})            .attr(\"d\", path(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; })));        svg.append(\"path\")            .st({fill:'none',stroke:'black'})            .attr(\"d\", path(nation));        // run the rest of the demos        updateColors(colors);    });}function deltaE(col1, col2) {    return 0.5*(chroma.deltaE(col1,col2)+chroma.deltaE(col2,col1));}d3.selectAll('.map-gradient').on('change', makeMap);\nSo here’s what we’re going to do\n\nWe need to extract a representative color sample\nThen look for color-pairs that are distinguishable under normal vision and\ncheck if any of them turn indistinguishable in a color blindness simulated view\nFinally we need to decide whether or not to show a warning.\n\n# Extracting a representative color sample\nNow, to check if this map is colorblind-friendly or not, we need to look at the colors used in it. In some graphics there might be just a handful of colors, but since this is a continuous US county choropleth map, we have a lot of them (TK, to be exact).\n\nSince the next step will involve checking each combination of these colors, it would result in a lot of permutations (TK, to be exact). So in order to save some work we need to reduce the number of colors.\nMy first approach was to use random sampling. To illustrate this, let’s look at 20 random colors from the palette above:\n\nThis might look like a nice sample at first glance, but due to the is random sampling we might end up with more colors from either spectrum of the palette. Click the button below to try a few more samples.\nRepeat random sampling\nTo get around this problem I tried to find a more deterministic sampling method that gives us a representative collection of colors. Since color blindness affects hue perception I thought it made sense to get a good sample of the entire hue-spectrum. So I sorted all colors by hue…\n\n…and then pick 20 evenly spaced colors along this spectrum. Like taking a sample every 5th percentile. To deal with interpolation (in case a percentile falls exactly between two colors) I used the scale.colors() method in chroma.js.\n\n\n1\n\nvar sample = chroma.scale(sorted_colors).colors(20);\n\n\nAnd this is what the sample looks like:\n\nfunction updateColors(colors) {    d3.select('.all-colors').html('')        .appendMany('div.color', colors.values())        .st('background', d3.f());    var numColors = colors.size();    // update color counts    d3.select('.num-colors').text(numColors);    d3.select('.num-pairs').text(d3.format(',')((numColors * (numColors-1))/2));    // update random sample    randomSample();    hueSample();    d3.select('.resample-random').on('click', randomSample);    // random sampling    function randomSample() {        var sample = _.sample(colors.values(), 20);;        d3.select('.random-colors').html('')            .appendMany('div.color', sample)            .st('background', d3.f());    }    // hue sorted percentiles    function hueSample() {        var sorted = colors.values().sort(d3.ascendingKey(function(col) {            return chroma(col).get('lch.h') || 1000;        }));        // show all sorted colors        d3.select('.all-colors-sorted').html('')            .appendMany('div.color', sorted)            .attr('title', function(c) { return chroma(c).get('lch.h'); })            .st('background', d3.f());        // show sample        var sample = chroma.scale(sorted).colors(20);        d3.select('.hue-sample').html('')            .appendMany('div.color', sample)            .st('background', d3.f())            .attr('title', function(c) { return chroma(c).get('lch.h'); });        // compute distance matrix        colorDistanceMatrix('.cdm-normal', sample);        cbsimTable(sample);    }}\nWe could experiment with other sampling methods, but for now these look good enough, so let’s move on. Next we want to find out which of the resulting 190 color pairs are actually distinguishable from another. To do that we need to find a method to compute differences between colors.\n# How to compute color differences\nThere are a couple of ways to do this. For instance, a color can be represented as three-dimensional coordinates in a R-G-B color space, so the color difference can be defined as the Euclidean distance between the two points.\ndistRGB=(R2−R1)2+(G2−G1)2+(B2−B1)2dist_{RGB}=\\sqrt{(R_2-R_1)^{2} + (G_2-G_1)^{2} + (B_2-B_1)^{2}}dist​RGB​​=√​(R​2​​−R​1​​)​2​​+(G​2​​−G​1​​)​2​​+(B​2​​−B​1​​)​2​​​​​\nHowever, after playing around with RGB distances a bit I noticed a problem: Look at the yellow/green and pink/blue combinations below. From eyeballing the colors I had expected the distance between yellow and green to be smaller than the pink/blue combination.\n    \n\n\n vs \n    \n\n\nBut it turns out, in RGB the distance is exactly 255 in both cases. This makes sense mathematically, since it takes 255 “steps” from (255,255,0) to (0,255,0) as well as from (255,0,255) to (0,0,255). But it doesn’t make sense visually.\nOf course, the same Euclidean distances can be computed in any other color space, so perhaps a perceptual color space like Lab or Lch makes more sense. Sadly, that’s not the case.\n    \nRGBLchLabdeltaE\n    \n        \n        \n\n\n        25541.466.326.9    \n    \n        \n        \n\n\n        25540.058.034.7    \n\nIn Lch, like RGB, both color pairs are almost equally distant. In Lab, the distance between yellow and green is even larger (66.3) than pink/blue (58.0).\nSo I ended up using a more fancy algorithm called deltaE or CMC l:c. It’s based on the Lch color model, but appears to work better.\nOne minor problem with deltaE is that it’s not symmetrical, meaning that the difference between yellow and green differs slightly from the difference between green and yellow. To get around this problem I am using the mean of the distances in both direction:\ndist(c1,c2)=deltaE(c1,c2)+deltaE(c2,c1)2dist(c_{1},c_{2})=\\frac{deltaE(c_{1}, c_{2}) + deltaE(c_{2}, c_{1})}{2}dist(c​1​​,c​2​​)=​2​​deltaE(c​1​​,c​2​​)+deltaE(c​2​​,c​1​​)​​\nNow let’s move from the difference between two colors to the difference between all the colors!\n# Compute the color distance matrix\nTo do that we compute the color distance matrix. Which is a fancy word for a table with rows and columns for each of our sample colors, and the distance between each color combination shown in the table cells.\n\nfunction colorDistanceMatrix(cont, sample, baseline) {    var hm = chroma.scale(['#eee','#ddd', '#666']).domain(baseline ? [1,3,10] :[0,10,70]).out('hex');    var table = d3.select(cont).html('');    var tr = table.append('tr');    if (baseline) {        tr.append('td');        tr.append('td');        tr.appendMany('th.color', baseline).st('background', d3.f());        tr = table.append('tr');        tr.append('td');    }    tr.append('td');    tr.appendMany('th.color', sample).st('background', d3.f());    tr = table.appendMany('tr', sample);    if (baseline) {        tr.append('th.color').st('background', (d,i) =\u003e baseline[i]);    }    tr.append('th.color').st('background', d3.f());    tr.appendMany('td', function(a, ia) {            return sample.map(function(b, ib) {                var diff = deltaE(a,b);                return {                    a, ia, b, ib,                    diff: baseline ?                        // difference ratio                        (deltaE(baseline[ia],baseline[ib])/diff).toFixed(1)                        : diff.toFixed(0)                };            });        })        .style('background-color', d3.f('diff', hm))        .text(d3.f('diff'))        .classed('relevant', (d) =\u003e d.ib \u003e d.ia \u0026\u0026 d.diff \u003e= (baseline ? 2 : 8))        .classed('strong', (d) =\u003e d.diff \u003e= (baseline ? 5 : 40))        .classed('lower', (d) =\u003e d.ib \nWe only need to look at the upper half of the matrix – the lower half is just an exact mirror. I highlighted all values above 45 so the combinations with the largest color differences pop out a bit more.\nNow we need to compute the same matrix with the colorblind-simulated versions of our colors.\n# Simulating color blindness\nColor blindness simulation is done by mapping colors from RGB to a reduced color space. It means that you have a function that gets one color as input and returns a new color.\nAfter googling around a bit I settled on a NPM package color-blind, which provides a fairly simple API:\n\n\n1\n2\n\nvar blinder = require('color-blind');\nblinder.protanopia('#42dead'); // result: \"#d1c4a0\"\n\n\nHere is our color sample mapped through three kinds of color blindness:\n\nfunction cbsimTable(sample) {    var table = d3.select('.simulated').html('');    var tr = table.appendMany('tr', ['normal','deuteranopia','protanopia','tritanopia']);    tr.append('td').append('b').text(d3.f());    var div = tr.append('td').append('div.colors.large');    div.appendMany('div.color', function(t) {            return t == 'normal' ? sample :                sample.map(function(c) { return blinder[t](c); })        })        .style('background', d3.f());    simColorMatrix(sample);    simColorRatioMatrix(sample);    summaryTable(sample);}\nNow we can just repeat the color difference matrix for the converted sample colors:\n\nYou can click through the buttons below to see the color difference matrix for each color blindness simulation:\n    normal    deuteranopia    protanopia    tritanopia\nfunction simColorMatrix(sample) {    var btns = d3.selectAll('.select-simulation button'),        typ = d3.select('.select-simulation button.selected').text();    btns.on('click.vis4', function() {        btns.classed('selected', false);        d3.select(this).classed('selected', true);        simColorMatrix(sample);    });    var colors = typ == 'normal' ? sample :        sample.map(function(c) { return blinder[typ](c); });    colorDistanceMatrix('.cdm-sim', colors);}\n# Computing difference ratios between normal and colorblind vision\nWe’re getting closer to the finish line! The only thing that’s left to do now is to compare the differences under normal vision with the differences under a color blindness simulation.\nOne way to do this is to look at the ratio between the two differences:\nratio(c1,c2)=distnormal(c1,c2)distcolorblind(c1,c2)ratio(c_1,c_2)=\\frac{dist_{normal}(c_1,c_2)}{dist_{colorblind}(c_1,c_2)}ratio(c​1​​,c​2​​)=​dist​colorblind​​(c​1​​,c​2​​)​​dist​normal​​(c​1​​,c​2​​)​​\nTo illustrate the ratio, let’s look at the notorious green/red color pair and compute the differences between them after applying different colorblindness simulations.\n\nfunction colorRatios(col1, col2) {    var table = d3.select('.color-ratios').html('');    var modes = ['normal','deuteranopia','protanopia','tritanopia'];    table.append('tr').appendMany('th', [''].concat(modes)).text(d3.f());    var dist_norm = deltaE(col1,col2);    var columns = modes.map(function(mode) {        var c1 = mode == 'normal' ? col1 : blinder[mode](col1);        var c2 = mode == 'normal' ? col2 : blinder[mode](col2);        var dist = deltaE(c1,c2);        return {            mode: mode,            colors: [c1,c2],            distance: dist,            ratio: dist_norm.toFixed()+'/'+dist.toFixed()+' = '+ (dist_norm / dist).toFixed(1)+''        };    });    // colors    var tr = table.append('tr');    tr.append('td').text('Colors');    tr.appendMany('td.color', columns)        .append('div.colors.xlarge')        .appendMany('div.color', (col) =\u003e col.colors)        .style('background', d3.f());    // distance    tr = table.append('tr');    tr.append('td').text('Distance');    tr.appendMany('td', columns)        .text((col) =\u003e col.distance.toFixed(0));    // ratio    tr = table.append('tr');    tr.append('td').text('Ratio').style('font-weight','bold');    tr.appendMany('td', columns)        .html((col) =\u003e col.ratio);}colorRatios('#54ae49', '#f06c62');\nA ratio of 17.3 means that a color pair is seventeen times more differentiable under normal vision than under this type of color blindness. The higher the ratio the more information is “lost” for a colorblind person. This is what we’ll use to decide what colors are ok or not.\nNow, to look at all the ratios at once, let’s make another matrix. The table looks just like the matrices we’ve seen before, except now the values in the cells show the ratio between the normal distance and the colorblind distance for each color pair.\n\n    normal    deuteranopia    protanopia    tritanopia\nfunction simColorRatioMatrix(sample) {    var btns = d3.selectAll('.select-simulation2 button'),        typ = d3.select('.select-simulation2 button.selected').text();    btns.on('click.vis4', function() {        btns.classed('selected', false);        d3.select(this).classed('selected', true);        simColorRatioMatrix(sample);    });    var colors = typ == 'normal' ? sample :        sample.map(function(c) { return blinder[typ](c); });    colorDistanceMatrix('.cdm-sim-ratios', colors, sample);}\nYou can use the buttons to cycle through the different simulations.\nAll that’s left to do now is to decide when to show a warning.\n# When to show a color warning\nOne criteria to check for I came up with is to check how many of the color pairs that were differentiable under normal vision turn into non-differentiable color pairs under colorblind vision. I also found that difference ratios above five signal a significant loss of information. So I ended up using a mix of both to decide when to trigger warnings.\nAs you can see in the table, it all depends highly on where I set the thresholds. You can tweak the sliders below to change them and see the results changing.\n\n    Difference threshold: \n    Ratio threshold: \n    Warning threshold: %\n\n    function summaryTable(colors) {        d3.selectAll('.summary-ctrls input').on('input', function() {            summaryTable(colors);        });        var ratio_thresh = +d3.select('.ratio-input').prop('value');        var diff_thresh = +d3.select('.diff-input').prop('value');        var warning_thresh = +d3.select('.warning-input').prop('value');        console.log('rrr', ratio_thresh, ratio_thresh.toFixed(1));        d3.select('.ratio-thresh').html(ratio_thresh.toFixed(1));        d3.select('.diff-thresh').html(diff_thresh.toFixed(1));        d3.select('.warning-thresh').html(warning_thresh.toFixed(1));        var table = d3.select('.summary').html('');        var modes = ['normal', 'deuteranopia','protanopia','tritanopia'];        table.append('tr').appendMany('th', [''].concat(modes)).text(d3.f());        var num_colors = colors.length,            num_perm = (colors.length*(colors.length-1))/2;        // var dist_ratio = (chroma.deltaE(col1,col2)+chroma.deltaE(col2,col1))*0.5;        var columns = modes.map(function(mode) {            // var c1 = mode == 'normal' ? col1 : blinder[mode](col1);            // var c2 = mode == 'normal' ? col2 : blinder[mode](col2);            // var dist = (chroma.deltaE(c1,c2)+chroma.deltaE(c2,c1))*0.5;            var diff_colors = 0,                cnt_ratio = 0,                cnt_sim_diff = 0,                max_ratio = 0,                sum_ratio = 0;            colors.forEach((col_a, i) =\u003e {                colors.forEach((col_b, j) =\u003e {                    if (j\u003ei) {                        var dist_norm = deltaE(col_a, col_b);                        if (dist_norm \u003e= diff_thresh) {                            diff_colors++;                            if (mode != 'normal') {                                var sim_a = blinder[mode](col_a),                                    sim_b = blinder[mode](col_b);                                var dist_sim = deltaE(sim_a, sim_b);                                if (dist_sim  max_ratio) max_ratio = ratio;                                if (ratio \u003e= ratio_thresh) cnt_ratio++;                            }                        }                    }                });            });            var ratio_pct = 100*(cnt_ratio/diff_colors);            var diff_pct = 100*(cnt_sim_diff/diff_colors);            return {                mode: mode,                colors: mode == 'normal' ? num_colors : '-',                permutations: mode == 'normal' ? num_perm : '-',                differentiable: mode == 'normal' ? diff_colors : '-',                sim_not_diff: mode == 'normal' ? '' : cnt_sim_diff + ' ('+diff_pct.toFixed(1)+'%)',                ratio: mode == 'normal' ? '' : cnt_ratio+' ('+ratio_pct.toFixed(1)+'%)',                ratio_avg: mode == 'normal' ? '' : (sum_ratio / diff_colors).toFixed(1),                ratio_max: mode == 'normal' ? '' : (max_ratio).toFixed(1),                warning: mode== 'normal' ? '' : ratio_pct \u003e= warning_thresh || diff_pct \u003e warning_thresh ? 'WARNING' : 'ok'                // colors: [c1,c2],                // distance: dist,                // ratio: dist_norm / dist            };        });        // number of colors        var tr = table.append('tr');        tr.append('td').text('Colors');        tr.appendMany('td', columns).text(d3.f('colors'));        // number of color permutations        tr = table.append('tr');        tr.append('td').text('Color pairs');        tr.appendMany('td', columns).text(d3.f('permutations'));        // of those, differentiable        tr = table.append('tr');        tr.append('td').html('Differentiable color pairs');        tr.appendMany('td', columns).text(d3.f('differentiable'));        // hr        // tr = table.append('tr');        // tr.append('td').attr('colspan', 4)        //     .st({textAlign:'center', color: '#999'})        //     .text('of those...');        // non differentiable        tr = table.append('tr');        tr.append('td').html('..that turn into non-differentiable\npairs under colorblind simulation');        tr.appendMany('td', columns).text(d3.f('sim_not_diff'));        // of those, differentiable        // tr = table.append('tr');        // tr.append('td').text('Avg. ratio');        // tr.appendMany('td', columns).text(d3.f('ratio_avg'));        // // of those, differentiable        // tr = table.append('tr');        // tr.append('td').text('Max. ratio');        // tr.appendMany('td', columns).text(d3.f('ratio_max'));        // of those, differentiable        tr = table.append('tr');        tr.append('td').text('Ratio \u003e '+(ratio_thresh.toFixed(1)));        tr.appendMany('td', columns).text(d3.f('ratio'));        // of those, differentiable        tr = table.append('tr');        tr.append('td').text('Result');        tr.appendMany('td', columns).html(d3.f('warning'));        // of those, differentiable    }\nFeel free to scroll back to the top and try out different colors in the map. All the examples and matrices in this post will change accordingly. Let me know if you find bugs along the way.\n# Some ideas for future improvements\nThis algorithm was hacked together in a few days, so obviously there are possible improvements to be made. Here are a few ideas that might be worth exploring:\n\nInstead of the hue-percentiles we could try different methods to find the most “representative” colors, such as k-means clustering.\nOne could look out for different color difference metrics, ideally by having (non-colorblind) people “guess” color differences and compare these results with the various color difference formulas.\nMaybe there are smarter ways to compare the color differences between normal and colorblind vision than looking at the ratios?\nMaybe there are smarter ways to decide how many “problematic” colors are enough to trigger the color blindness warning.\nClearly, it would help testing a larger set of charts and maps with this algorithm to measure its real performance\n\nAs always I’m happy to hear what you think. Feel free to drop a comment below or send me an email at gregor@datawrapper.de.\n    makeMap();    svg,canvas {top:0;}    button { font-size: 15px; padding: 5px 15px;  }    .colors { line-height: 0;  padding: 2px 0 0 2px; display: inline-block;}    .colors .color { box-sizing: border-box; border: 2px solid white; display: inline-block;        width: 16px; height: 16px; margin: -2px 0 0 -2px; }    .colors.large .color { width: 28px; height: 28px;  }    td .colors.large .color { width: 24px; height: 24px;  }    .colors.xlarge .color { width: 38px; height: 38px;  }    .colors.xlarge .color+.color{ border-left: 0 }    .all-colors-sorted { border-left: 2px solid white }    .all-colors-sorted .color{ border-left: 0 }    .content table.color-distance-matrix { cursor:pointer;overflow: hidden; z-index: 1; border-spacing: 0; border-collapse: separate; border: 1px solid white;}    .color-distance-matrix th,    .color-distance-matrix td { border:1px solid white; padding:0; color: #888;}    .color-distance-matrix th { width:16px; height:21px; }    .color-distance-matrix td { font-size: 11px; text-align: center;vertical-align: middle; position: relative;}    .color-distance-matrix tr:hover { background: #e0e0e0 }    .color-distance-matrix td:hover::after {        background-color: #e0e0e0; content: '\\00a0';height: 10000px;left: 0;position: absolute;        top: -5000px;width: 100%;z-index: -1;    }    .summary-ctrls label { display: inline-block; font-size: 14px; margin-right: 15px }    label input[type=range] { vertical-align: middle; margin: 0;}    .color-distance-matrix td:hover { background: #ccc; }    .color-distance-matrix td.relevant { color: #333; }    .color-distance-matrix td.strong { font-weight: bold; color:#fff;}    .color-distance-matrix td.lower { color: #d7d7d7; background: transparent!important;}","summary":"\u003cp\u003eEarlier this week we released a new feature at Datawrapper that \u003ca href=\"https://blog.datawrapper.de/colorblind-check/\" target=\"_blank\" r","id":"https://vis4.net/blog/2018/02/automate-colorblind-checking/","isoDate":"2018-02-08T14:09:30.000Z","blogTitle":"vis4.net"}},"__N_SSG":true},"page":"/[...slug]","query":{"slug":["i-wrote-some-code-that-automatically-checks-visualizations-for-non-colorblind-safe-colors-heres-how-it-works"]},"buildId":"qDg91nRpW1T3K0AfdjzxW","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>