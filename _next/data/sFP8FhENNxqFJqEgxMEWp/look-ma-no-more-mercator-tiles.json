{"pageProps":{"post":{"title":"Look, Ma, No More Mercator Tiles","link":"https://vis4.net/blog/2015/01/no-more-mercator-tiles/","pubDate":"2015-01-06T20:06:32.000Z","content":"<p>Using open source tools it is now super easy to make your own map tiles, and with a little extra work you can render them in whatever map projection you want. No more excuses to use Mercator! For example, <a href=\"http://www.nytimes.com/interactive/2015/01/06/upshot/where-working-women-are-most-common.html?rref=upshot\" target=\"_blank\" rel=\"noopener\">here is a map</a> we published today at The Upshot. It shows where prime-age women are working more or less then average, and includes data from county-level in the overview map down to every census tract once you zoom in. And all is nicely projected in <a href=\"http://en.wikipedia.org/wiki/Albers_projection\" target=\"_blank\" rel=\"noopener\">Albers Equal-Area Conic</a>, a projection widely adopted as standard for U.S. maps.</p><div class=\"poster poster-945\"><p><img src=\"/blog/images/old/35b642ff6b3c1acd1e2813e252d22693.png\" alt=\"\"></p></div><h2 id=\"so-how-does-this-work\"><a class=\"anchor\" href=\"#so-how-does-this-work\"><span class=\"header-anchor\">#</span></a> So how does this work?</h2><p>After many years of blindly accepting the dominance of Web Mercator tile maps, I was quite surprised to learn how easy it is to use whatever projection you want. So how does this work? The answer is that it works because <a href=\"http://mapnik.org/\" target=\"_blank\" rel=\"noopener\">Mapnik</a>, the core of many open source tile mapping frameworks, supports custom projections out of the box. It is just the tools built around Mapnik that are not supporting other projections. <a href=\"https://www.mapbox.com/tilemill/\" target=\"_blank\" rel=\"noopener\">Tilemill</a>, for instance, is a super nice tool for styling map tiles in a <a href=\"https://www.mapbox.com/tilemill/docs/manual/carto/\" target=\"_blank\" rel=\"noopener\">CSS like language</a>. But if you export your map as tiles using Tilemill, you are stuck with Web Mercator, even though internally it is Mapnik that renders all the tiles. Fortunately this doesn‚Äôt mean that you have to deal with Mapnik and it‚Äôs quirks directly to get custom projections.</p><h2 id=\"step-1-export-mapnik-xml-and-change-projection\"><a class=\"anchor\" href=\"#step-1-export-mapnik-xml-and-change-projection\"><span class=\"header-anchor\">#</span></a> Step 1: Export Mapnik XML and change projection</h2><p>So the first step is to style your map just as you would with a Mercator map, enjoying the full feature-set of Tilemill. Once you‚Äôrd done with that you <a href=\"https://www.mapbox.com/tilemill/docs/manual/exporting/#mapnik-xml-export\" target=\"_blank\" rel=\"noopener\">export your project as Mapnik XML</a>. Think of this XML file as the entire description of your map. It contains all the references to the source layers and all the styles for the map features ‚Äì in one single file. If you actually read the code of the file you will quickly realize how extremely lucky we are to have Tilemill and CartoCSS. And you might also notice that in the root element of the document, named <code>&lt;Map&gt;</code>, you find the the definition of the map projection as Proj.4 string in the <code>srs</code> attribute (for spatial reference system). And you can simply change it to whatever you want. In this case I replaced the Mercator projection with the Albers projection (copied from the Proj.4 definition <a href=\"http://spatialreference.org/ref/esri/usa-contiguous-albers-equal-area-conic/\" target=\"_blank\" rel=\"noopener\">linked here</a>):</p><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Map</span> <span class=\"attr\">srs</span>=<span class=\"string\">\"+proj=aea +lat_1=29.5 +lat_2=45.5</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">   +lat_0=37.5 +lon_0=-96 +x_0=0 +y_0=0 +ellps=sphere</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">   +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +nadgrids=@null\"</span></span></span><br><span class=\"line\"><span class=\"tag\">   <span class=\"attr\">background-color</span>=<span class=\"string\">\"#ffffff\"</span>&gt;</span></span><br></pre></td></tr></table></figure><p>I copied the Proj.4 string from <a href=\"http://spatialreference.org/ref/esri/usa-contiguous-albers-equal-area-conic/\" target=\"_blank\" rel=\"noopener\">spatialreference.org</a>, where you find many other standard projections as well. (Hint: If you plan on aligning the tile map to a D3.js projected vector overlay you should append <code>+nadgrids=@null</code> to the Proj.4 string) To preview the projection I used <a href=\"http://tilestache.org/\" target=\"_blank\" rel=\"noopener\">TileStache</a>. All it needs is a <a href=\"http://tilestache.org/doc/#configuring-tilestache\" target=\"_blank\" rel=\"noopener\">JSON configuration</a> file that points to the exported Mapnik XML as input layer.</p><figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">\"cache\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"attr\">\"name\"</span>: <span class=\"string\">\"Disk\"</span>, <span class=\"attr\">\"path\"</span>: <span class=\"string\">\"tiles\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"attr\">\"layers\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"attr\">\"map\"</span>: &#123;</span><br><span class=\"line\">            <span class=\"attr\">\"provider\"</span>: &#123;<span class=\"attr\">\"name\"</span>: <span class=\"string\">\"mapnik\"</span>, <span class=\"attr\">\"mapfile\"</span>: <span class=\"string\">\"mapnik.xml\"</span>&#125;,</span><br><span class=\"line\">            <span class=\"attr\">\"projection\"</span>: <span class=\"string\">\"spherical mercator\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>Then you run <a href=\"http://tilestache.org/doc/#serving-tiles\" target=\"_blank\" rel=\"noopener\">tilestache-server.py</a> with your config and open <a href=\"http://localhost:8080/map/preview.html\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/map/preview.html</a> to preview the freshly rendered projected tiles, just as you would in Tilemill.</p><h2 id=\"step-2-figuring-out-which-tiles-to-render\"><a class=\"anchor\" href=\"#step-2-figuring-out-which-tiles-to-render\"><span class=\"header-anchor\">#</span></a> Step 2: Figuring out which tiles to render</h2><p>Now we come to the first tricky part of the process. We need to figure out which tiles we actually want to be rendered. You probably already know the zoom levels and the bounding box in WGS 84 lat/lon coordinates, but the latter won‚Äôt help us much since TileStache is designed for rectangular projections like Mercator. Fortunately TileStache also takes a text file with a list of Z/X/Y tile coordinates as input. To get this list of tiles I wrote <a href=\"https://gist.github.com/gka/52ef3bf442bed80367f6\" target=\"_blank\" rel=\"noopener\">a Python script</a> (feel free to re-use if you want). The script uses <a href=\"https://github.com/mapbox/mercantile\" target=\"_blank\" rel=\"noopener\">mercantile</a>, a Python library for tile calculations, which returns the tile coordinates for points in WGS84 lat/lon, assuming that the tiles are projected in Web Mercator. To trick the library into giving me the correct tiles, I converted the points to the custom projection first and then projected them ‚Äúback‚Äù from Web Mercator (even though the coordinates aren‚Äôt in Mercator). When mercantile gets my ‚Äúfake‚Äù lat/lon coordinates it projects them to Mercator (reversing my inverse projection) and ends up with the Albers Equal Area coordinates.</p><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">get_tile</span><span class=\"params\">(lon, lat, z)</span>:</span></span><br><span class=\"line\">    <span class=\"comment\"># project to custom projection</span></span><br><span class=\"line\">    pt = albers(lon, lat)</span><br><span class=\"line\">    <span class=\"comment\"># project \"back\" from Mercator</span></span><br><span class=\"line\">    pt2 = mercator(pt[<span class=\"number\">0</span>], pt[<span class=\"number\">1</span>], inverse=<span class=\"keyword\">True</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> mercantile.tile(pt2[<span class=\"number\">0</span>],pt2[<span class=\"number\">1</span>], z)</span><br></pre></td></tr></table></figure><p>Using this function I then <a href=\"https://gist.github.com/gka/52ef3bf442bed80367f6#file-make-tile-urls-py-L28-L30\" target=\"_blank\" rel=\"noopener\">compute the top-left and bottom-right tile</a> for each zoom level and <a href=\"https://gist.github.com/gka/52ef3bf442bed80367f6#file-make-tile-urls-py-L31-L33\" target=\"_blank\" rel=\"noopener\">add every tile</a> in between the two to my tile list. <img src=\"/blog/images/old/72fe22250e32ef5dfab3880b62fdb1f3.png\" alt=\"\"> The bounding box coordinates deserve a further note. Bounding boxes cannot be projected between non-rectangular coordinate systems. Here is an example showing a lat/lon bounding box that works fine in Mercator, projected to the Albers projection. Not only do we get too much empty space but we‚Äôre also missing significant parts of U.S. territory. <img src=\"/blog/images/old/073e5f51eef85b4206c2d4880352b499.png\" alt=\"\"> So instead we have to do the reverse approach and grab the Albers bounding box and then project it back to WGS 84 lat/lon (I used QGIS for this step). This bounding box I then used <a href=\"https://gist.github.com/gka/52ef3bf442bed80367f6#file-make-tile-urls-py-L21\" target=\"_blank\" rel=\"noopener\">in the Python script</a> to generate the tile urls. <img src=\"/blog/images/old/a14386ba2ae66a99aae91e9299dc67a9.png\" alt=\"\"> Finally we run <code>tilestache-seed.py</code> to pre-generate all the tiles in our list (you probably want to host them as static files somewhere), which may or may not take quite a while to finish.</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python make-tile-urls.py</span><br><span class=\"line\">tilestache-seed.py -c config.json --tile-list=tile-urls.txt --layer=map</span><br></pre></td></tr></table></figure><h2 id=\"step-3-translating-coordinates-in-web-map\"><a class=\"anchor\" href=\"#step-3-translating-coordinates-in-web-map\"><span class=\"header-anchor\">#</span></a> Step 3: Translating coordinates in web map</h2><p>Once we generated all our tiles we almost made it to the end. The tiles can be used just like Mercator tiles, so you are free to pick your favorite tilemap framework such as <a href=\"http://leafletjs.com/\" target=\"_blank\" rel=\"noopener\">Leaflet.js</a>, <a href=\"http://polymaps.org\" target=\"_blank\" rel=\"noopener\">Polymaps</a>, <a href=\"http://openlayers.org/\" target=\"_blank\" rel=\"noopener\">OpenLayers</a> or whatever you prefer. For our women employment map I went with <a href=\"http://modestmaps.com/\" target=\"_blank\" rel=\"noopener\">ModestMaps</a> which I like for its simplicity and ‚Äúhackability‚Äù. However, all of these frameworks assume that your tiles are in Mercator projection, so the built-in conversion from WGS 84 lat/lon to Mercator tile coordinates won‚Äôt work for us ‚Äì unless we do the same trick I showed above. First, we are going to need the two projections Web Mercator and Albers, which you find in the <a href=\"http://proj4js.org/\" target=\"_blank\" rel=\"noopener\">Proj.4 JavaScript fork</a>. Needless to say that you should use the exact same projection definition here.</p><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Web Mercator</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> mercator = proj4(<span class=\"string\">'+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 '</span></span><br><span class=\"line\">               + <span class=\"string\">'+x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext '</span></span><br><span class=\"line\">               + <span class=\"string\">'+over +no_defs'</span>),</span><br><span class=\"line\">    <span class=\"comment\">// Albers Equal Area</span></span><br><span class=\"line\">    albers = proj4(<span class=\"string\">'+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=37.5 +lon_0=-96 '</span></span><br><span class=\"line\">              + <span class=\"string\">'+x_0=0 +y_0=0 +ellps=sphere +nadgrids=@null '</span></span><br><span class=\"line\">              + <span class=\"string\">'+towgs84=0,0,0,0,0,0,0 +units=m +no_defs'</span>);</span><br></pre></td></tr></table></figure><p>Using these projection classes we can convert coordinates from the ‚Äòreal‚Äô WGS 84 lat/lon coordinates to the ‚Äòwrong‚Äô lat/lon coordinates on our map, by first projecting to Albers, and then inverse projecting ‚Äúback‚Äù from Web Mercator.</p><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">WGS84ToMap</span>(<span class=\"params\">pt</span>) </span>&#123;</span><br><span class=\"line\">    pt = mercator.inverse(albers.forward([pt.lon, pt.lat]));</span><br><span class=\"line\">    <span class=\"keyword\">return</span> &#123; <span class=\"attr\">lon</span>: pt[<span class=\"number\">0</span>], <span class=\"attr\">lat</span>: pt[<span class=\"number\">1</span>] &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>The same works in the reverse direction, too. I used this to display the current map coordinates in the URL hash, simply by passing the map center (the ‚Äòwrong‚Äô coordinates I get from <code>map.getCenter()</code>) to <code>mapToWGS84()</code>.</p><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">mapToWGS84</span>(<span class=\"params\">pt</span>) </span>&#123;</span><br><span class=\"line\">    pt = albers.inverse(mercator.forward([pt.lon, pt.lat]));</span><br><span class=\"line\">    <span class=\"keyword\">return</span> &#123; <span class=\"attr\">lon</span>: pt[<span class=\"number\">0</span>], <span class=\"attr\">lat</span>: pt[<span class=\"number\">1</span>] &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>And that‚Äôs basically all it needed to get the tile map library working with my custom projected tiles. Of course there is a lot more I could write about (and I will in future posts), but for now, let‚Äôs wrap this up: Making tile maps using custom projections isn‚Äôt that hard, and the beautiful maps are definitely worth it. You can use Tilemill just as usual, export Mapnik XML, change the projection in the XML and then render the tiles using TileStache. You can use these tiles in any tile map framework, but you have to convert coordinates from and to your ‚Äòwrong‚Äô lat/lons. If you have further questions or know a different approach for tile maps in custom projections, let us know in the comment section. Also, if you happen to work at <a href=\"https://www.mapbox.com/\" target=\"_blank\" rel=\"noopener\">Mapbox</a> or another company that produces tile map tools with a built-in limitation to rectangular projections, I would be curious to hear why you‚Äôre not willing to go the extra mile for the sake of beautiful maps. And in case you find this blog post helpful, please <a href=\"https://twitter.com/intent/tweet?text=How%20to%20make%20tile%20maps%20without%20using%20the%20Mercator%20projection%20(via%20@driven_by_data)&amp;url=http://vis4.net/blog/posts/no-more-mercator-tiles/\" target=\"_blank\" rel=\"noopener\">tweet it</a>! üòÉ</p><h1 id=\"comments\"><a class=\"anchor\" href=\"#comments\"><span class=\"header-anchor\">#</span></a> Comments</h1><p>Hannes (Jan 07, 2015)</p><blockquote><p>You should be able to find lots of software in/from the geo world, rather than the JS world, that was designed with support for any projection in mind. OpenLayers can handle any projection, there also is a Proj4 plugin for Leaflet. There are standards like TMS or WMS variants. This might make it all easier and less ‚Äúthrough the backdoor‚Äù. üòâ</p><p>Seeing web mercator being used for everything, just because some software dictated or suggested it, is painful for people with a cartographic background.</p></blockquote><p>Gregor (Jan 07, 2015)</p><blockquote><p>Indeed. I saw that OpenLayers can deal with projections and that there is a Leaflet Plugin for Proj4. I guess I partly wrote this post to convince maintainers of Mercator-bound geo software to consider adding support for custom projected tiles. The coordinate transformation should really be part of the frameworks,  and not of the map code.</p></blockquote><p>Calvin (Jan 07, 2015)</p><blockquote><p>Jason Davies‚Äô work on <a href=\"http://www.jasondavies.com/maps/raster/\" rel=\"noopener\" target=\"_blank\">projected tiles</a> is pretty good and avoids the pitfall your solution has which is interoperability, the reason for using mercator tiles is because thats that the other tiles are in and for most maps it‚Äôs good enough.</p></blockquote><p>Gregor (Jan 07, 2015)</p><blockquote><p>Yeah, I know his work on projected tiles. It‚Äôs a nice trick, but it wouldn‚Äôt work in a real use case as the map labels get rotated and look blurry. You want crisp and horizontally aligned text on a map, right?</p></blockquote><p>s (Jan 07, 2015)</p><blockquote><p>Why not simply use a d3 projection for your project? I see no need for tiles.</p></blockquote><p>Gregor (Jan 07, 2015)</p><blockquote><p>Ha, I‚Äôm curious to hear how you would render this detail view of NYC just using D3.</p><p><a href=\"http://new.tinygrab.com/f3aa221ede71c30897f1a0998015ed988375dffdfc.png\" target=\"_blank\" rel=\"noopener\">http://new.tinygrab.com/f3aa221ede71c30897f1a0998015ed988375dffdfc.png</a></p><p>At the very least you would need vector tiles instead of image tiles, since the streets alone are several gigabytes.</p></blockquote><p>Steven Romalewski (Jan 08, 2015)</p><blockquote><p>This is a helpful post.  But following on Calvin‚Äôs comment, hasn‚Äôt the sole reason for using the Web Mercator projection been so you can overlay tiles on now-ubiquitous basemaps such as Google‚Äôs?</p><p>I agree that we shouldn‚Äôt ‚Äúblindly accept‚Äù the web Mercator projection, but there‚Äôs a reason for it, whether it‚Äôs a good reason or not.  I thought it would have made your post stronger if you had stated that obvious but perhaps overlooked point.</p><p>In other words, it wasn‚Äôt like we all just woke up yesterday and realized that we should be making maps in other projections.  There are thousands of map projections/coordinate systems that have been used for decades (centuries?), each with a particular purpose and/or location in mind.</p><p>But if you want to easily overlay your choropleth or other map layers on a pre-rendered basemap, for now there‚Äôs Google, Bing, MapQuest, and OSM and its variants.  And those are all web Mercator.</p><p>Noticeably the Times‚Äôs map in your blog post (which is very nice, btw) does not have much of a basemap other than neighborhood labels and streets.  True, you could argue that it doesn‚Äôt need any more than that.  But for now, if you don‚Äôt use web Mercator, you can‚Äôt use an ‚Äúoff-the-shelf‚Äù basemap - you‚Äôd need to create your own in the same custom projection, not necessarily a trivial task.</p><p>Anyway, you‚Äôre right that ‚Äúmaking tile maps using custom projections‚Äù isn‚Äôt complicated. But I thought the reason <em>why</em> we‚Äôve all been using web Mercator should‚Äôve been pointed out.  And it‚Äôd be nice if we could overlay non-web Mercator tiles on the now-standard basemaps (or, better yet, reproject those pre-rendered basemaps on the fly).  But maybe not being able to do that is (one of) the price(s) we‚Äôve been paying for these otherwise ‚Äúfree‚Äù services.</p></blockquote><p>Tom (Jan 08, 2015)</p><blockquote><p>Okay, I‚Äôll bite.</p><p>Reasons why Mapbox doesn‚Äôt support non-Mercator projections (yet):</p><p>Projection definitions are stuck in the 80s: you have to look up some string defining a projection and copy and paste it from place to place, or rely on a shorthand to that string and hope that it‚Äôs the right shorthand and you have the right CSV of projections stashed somewhere on your computer.</p><p>This is a fixable problem, but currently no-one has the technical and political skills to do it as well as a good reason to spend a lot of time on it.</p><p>Next: ‚Äúcompatibility over the internet‚Äù: the sort of problem for which other technology has the html ‚Äòlang‚Äô attribute and magic numbers in binary files and so on. There is nothing for this: having Leaflet know what projection a layer is in, without copying and pasting JavaScript or some hopefully-accurate proj4 string is just not a reality.</p><p>Which brings us to the user expectation that layered maps should work. Back in the day, I worked with OpenLayers, which offered glorious projection support: really, it had gone all-in on making everything projection-related possible, though not easy. And this was the cause of a tremendous percentage of all support: it is a reasonable expectation that you can combine map layers of different projections and it‚Äôll work, but it can‚Äôt. Tiles are baked images and they are baked in projections, never to be warped without significant artifacting (see MapProxy).</p><p>So, metadata doesn‚Äôt exist, user expectations are not set, finally tiling. Virtually all tiled sources use the OSM ‚ÄúXYZ‚Äù tiling scheme, which is only defined for Spherical Mercator and, for each other projection, is a big question mark. Schemes that try to resolve this, like WMTS, have fallen into the overstandardized complexity gotcha, with each projection also having sort of meta-choices around exactly where you want to slice and how. They‚Äôre too big to be popular, when XYZ tiles are so simple a novice coder can write a tiling client.</p><p>Which brings us to vector tiles. The popular conception of vector tiles is that they‚Äôre ‚Äújust vector data‚Äù and thus all further choices are free. Unfortunately, this isn‚Äôt true: vector tiles are <em>tiles</em>, and to be efficient they need to be simplified. An efficient simplification is perceptual, so they‚Äôre simplified to the tiling scheme, which is - you guessed it - Spherical Mercator. A bummer, but the upside is that dynamic reprojection of vector tiles has radically less distortion than reprojection of raster tiles, so it is a big win.</p><p>I hope this clears up some of the rationale for why this isn‚Äôt easy to do technically. I‚Äôll close with two quick non-technical notes:</p><p>Firstly: demand for non-Mercator projections is a high-level user request from people who are really into cartography. Projections are invisible for the vast majority of developers, designers, and consumers. And for people who are into cartography but also need a different dimension - like tons of data or easy compatibility with non-Leaflet APIs - the complexity disadvantages of custom projections outweigh the wins, fast.</p><p>The problem here is that, while this was doable for you, it consisted of four technical steps that all have decisions baked in - decisions that you can make and you can accept at each level. You made the map, you know it‚Äôs in a projection, you can configure Leaflet and know that it isn‚Äôt going to work with a different tile layer, or a map you make in a different projection. The problem that a larger system (eg Mapbox) would have to solve is to make a general solution for each of these steps, as well as all of the bumpers to make this less of a usability nightmare: how do you use this map in iOS? In GL? If you have related information to geocode from, is the vector tile data projected as well? Or not projected, in a separate tileset?</p></blockquote><p>Paul Ramsey (Jan 08, 2015)</p><blockquote><p>Agree w/ everything except the metadata argument at the top. OGC WKT for SRS is ‚Äúgood enough‚Äù to represent all kinds of projections in a nice standard way, and even includes niceties like spheroid/datum handling (which proj is more flakey about). And handling it is a solved problem. Death to ESPG codes.</p></blockquote><p>Matthew (Jan 08, 2015)</p><blockquote><p>The cartographic argument for non-Mercator maps is compelling - I too like looking at maps in other projections - but I think it‚Äôs a fair point that, if all you‚Äôre doing is plotting some data on a map, the interop advantages to Mercator are worth the compromise.</p><p>&gt; Projections are invisible for the vast majority of developers‚Ä¶</p><p>For anything beyond simply dumping your data on a map, that‚Äôs precisely the problem. Sweeping the complexity of projections under the rug and saying ‚Äúlook how easy this is now‚Äù is not a solution. Projections fundamentally alter the results of geospatial analyses; they are a necessary and fundamental core concept, an absolute prerequisite to doing anything with geographic data.</p><p>Any analysis with spatial relationships, area, distance, direction and geometric overlays are compromised if you are working in the wrong projection.  I can‚Äôt wait to see what stupid mistakes arise ‚Äúdoing GIS‚Äù in javascript without consideration for projections.</p></blockquote><p>Tom (Jan 08, 2015)</p><blockquote><p>This is a discussion of <em>output</em> in projections for display. This is entirely separate to how data is stored, or in which projection it is processed - I don‚Äôt see how jabs at ‚ÄòGIS in JavaScript‚Äô are relevant. Nobody stores their raw data in ‚Äòmercator‚Äô and nobody‚Äôs suggesting that.</p></blockquote><p>Matthew (Jan 08, 2015)</p><blockquote><p>Yeah sorry, the jab at ‚ÄúGIS in Javascript‚Äù was unnecessary. It‚Äôs more a jab at the general idea that you can do anything significant with geographic data without consideration for projections. You can‚Äôt sweep it under the rug: projections have real implications for storing, analyzing <em>and</em> displaying any geographic data. The ‚Äúit doesn‚Äôt matter, just use Mercator‚Äù approach is not ultimately helpful to the geospatial developer community.</p></blockquote><p>Gregor (Jan 08, 2015)</p><blockquote><p>Btw, Mike just pointed me to this demonstration of streets rendered from vector tiles in D3: <a href=\"http://bl.ocks.org/mbostock/5593150\" target=\"_blank\" rel=\"noopener\">http://bl.ocks.org/mbostock/5593150</a></p></blockquote><p>Tom (Jan 08, 2015)</p><blockquote><p>Then we‚Äôre in agreement: it is extremely important to know about geographic data in depth if you‚Äôre going to analyze it. The difference between projections <em>in data</em> and <em>in output</em> is important: nobody‚Äôs should do their analysis in web mercator. The output of their analysis on a web mercator map is a totally different concern.</p><p>And I don‚Äôt mean to belittle projections in general: they are useful and interesting, and for some analysis, mercator really doesn‚Äôt cut it (mostly for the arctic). I think in a lot of cases, mercator <em>does</em> cut it: a person doing a scaled-point map in their small American city shouldn‚Äôt spend an hour choosing their projection, just like you shouldn‚Äôt spend a bunch of time choosing fonts in your school essays: that‚Äôs a distraction.</p><p>But it is important to understand <em>why</em> mercator is the default in so many places and the technical issues surrounding it. That‚Äôs the only way we can really grasp what‚Äôs on the todo list to make custom output projections less of a technical gotcha.</p></blockquote><p>Gregor (Jan 08, 2015)</p><blockquote><p>Tom, thanks so much for helping us to understand this.</p><p>I agree, once you‚Äôre at the point where you want to combine different map layers you get into big trouble. And while I can see why Mapbox is not investing more resources into this feature, there are still a few (simple) things that could significantly help making custom projected tiles in Tilemill:</p><ul><li>Allowing to set the projection per project and simply passing it on to Mapnik. If I can preview maps in custom projections easily in TileStache, this should work in Tilemill, too. This could be a feature marked as ‚Äòexperimental‚Äô with big warning signs to keep away less ‚Äòhigh-level‚Äô users.</li><li>It would be nice if Tilemill could export separate Mapnik XML styles for Retina tiles.  I found a way to do this using a global @scale variable to rescale line withs and font sizes, and shifting the zoom level.</li><li>Finally, Tilemill could also allow exporting tiles in custom projection, essentially just by letting Mapnik do it‚Äôs job. Then end-users like me would not need to use TileStache.</li></ul><p>Maybe I try hacking this into Tilemill one day‚Ä¶</p></blockquote><p>Bill (Jan 08, 2015)</p><blockquote><p>Gregor, I‚Äôm probably oversimplifying for your specific use case, but I‚Äôve always found it easy enough to use custom projections in Tilemill without resorting to the Mapnik XML or a custom tile server. By lying to Tilemill when loading layers (‚ÄúWhy yes, computer friend, this shapefile IS in EPSG:900913!‚Äù), you can <a href=\"http://wboykinm.github.io/income-2012/#5/16.067/-1.362\" rel=\"noopener\" target=\"_blank\">render in Albers US</a>, then bake the tiles to mapbox hosting or chop them up with mbutil for static serving. The only downside is the obviously-incorrect internal geolocation (note the hash).</p></blockquote><p>Friedrich Hartmann (Jan 09, 2015)</p><blockquote><p>First I want to point out that Spherical Mercator still excels for global coverage of raster data to be viewed at small scales (street level to region) due to it‚Äôs conformal properties. It‚Äôs just ill-suited for continental to global map view extents.</p><p>And since, in the past, clients were only meant to stitch image tiles back together the tiling was inherently linked to the map projection since all the labels were already baked in and distorting them by means of reprojection simply would make things look not as nice as they should be.</p><p>This problem and limitation is avoidable in client side rendering of vector data as stated here before, the hard dependency between the geo data‚Äôs coordinate system and the displayed map projection is not in existence anymore.  So why keep the old tiling schemes? Projection definitions are definitely not the problem here, neither are they stuck in the 80‚Äôs nor are they inherently hard to understand, especially the so called geometric projections. Also there is the need to be made a distinction between the data‚Äôs geographic coordinate system and Datum (WGS84, NAD83) and projected coordinate systems like UTM called coordinate reference systems (CRS), these all are different beast. The part that is responsible for the complexity of the CRS string is not the projection it‚Äôs the arbitrary definition of the different coordinate systems and the transformation between them.</p><p>I see it as eventually inevitable to adopt a better tiling scheme for global vector data than an equirectangular or Mercator grid. They both have at least some major drawbacks, compared to better suited hierarchical geodesic grids. One is being not equal area, which means an uneven number of calls and different amount of area coverage per tile based on latitude of the tile at the same scale. Where the equirectangular grid merely has two singularities,  the spherical Mercator square has no coverage at all, at the poles beyond 85¬∞, which disqualifies it as a global all purpose tiling scheme all together. An improvement would be to replace the usual rectangular data tiling with something more appropriate for the type of data we‚Äôre dealing with here, which are in the end points on an ellipsoid or sphere; in most cases a sphere will do.</p><p>There exist some not too complex alternatives like the Icosahedron Snyder Equal Area (ISEA) grid or HEALPix, which is well established and has quite solid support and libraries around it in the astronomical community (check out TPZF/GlobWeb on GitHub). Another benefit of having an equal area grid is being able to make statistical comparison between tiles on the same hierarchy level, like nodes per km¬≤, which is not dorictly possible in the current grids used for vector map tiles.</p><p>Doing the server side generalization within the projected CRS of the geodesic grid tiles would further harmonize the level of generalization across the globe, generalizing in equirectangular Cartesian space is a bad idea to begin with.</p><p>To sum up, I strongly recommend adopting a geodesic grid based tiling scheme for vector based maps.</p></blockquote><p>Aaron Dennis (Jan 09, 2015)</p><blockquote><p>I hate looking at the whole US in web mercator, too, but I find it equally unattractive to see zoomed in versions of the states on the east and west coasts that are tilted because the central meridian of their Albers projection is a thousand miles away.</p><p>Beyond interoperability with other web maps, Mercator is actually great at preserving local angles. If you want a map that let‚Äôs you zoom to any place and scale in the country, Mercator might be the best choice.</p><p>It seems the solution might be vector tiles projected ‚Äúon the fly.‚Äù We‚Äôll probably get there, but Mercator does okay for now.</p></blockquote><p>Gregor (Jan 09, 2015)</p><blockquote><p>I could hold against your argument that (1) the idea of North direction showing up is a rather artificial concept anyway and that (2) this wouldn‚Äôt be the first map where North is not showing up and also that (3) North being <em>exactly</em> up isn‚Äôt a really important feature of a map unless you looking for shortest way to the North pole ‚Äî but still I can see your point. Especially when you look at Alaska and Hawaii, which are shown equal-area but ‚Äòrotated‚Äô to an unfortunate degree.</p><p>Still better than Mercator in the full U.S. view. Guess next time I switch from Albers to Mercator tiles at some zoom level.</p></blockquote><p>Friedrich Hartmann (Jan 10, 2015)</p><blockquote><p>Albers also preservers angles within and around it‚Äôs standard parallels very well. And Lambert conformal conic projection even preserves them everywhere. It‚Äôs basically the same as Mercator but using a cylinder as projective Surface.</p><p>For interactive maps there is even the possibility to have dynamic projection parameters based on the active view scale. While this is hard to realize for raster tile maps (no smooth transitions feasible due to fixed number of zoom scales), it‚Äôs quite realistic to do this for vector based ones. Continental view would be Lambert, as you zoom in it‚Äôs being gradually transitioned into Mercator, by interpolating between the two projections, this way it‚Äôs even directly compatible with raster tiles on higher zoom levels.</p><p><a href=\"http://cartography.oregonstate.edu/ScaleAdaptiveWebMapProjections.html\" target=\"_blank\" rel=\"noopener\">http://cartography.oregonstate.edu/ScaleAdaptiveWebMapProjections.html</a></p></blockquote><p>Jamie Robertson (Mar 20, 2015)</p><blockquote><p>Great Post! I‚Äôve been working on my own tiles and they are working great in the tilestache previewer. I‚Äôm struggling with getting the last few functions you noted in step 3 to work with leaflet. Do you happen to have some example code for that, or with modestmaps? Thanks!</p></blockquote><p>Chris (Jan 16, 2015)</p><blockquote><p>Saw this a bit late but thought i‚Äôd add a few notes that might be helpful to those who want to try using different projections in web maps.</p><p>As others have already hinted for a zoomable map in conic projection Lambert is probably a better choice than Albers, for a whole country map showing statistical quantities the equal-area property might be considered more important of course.</p><p>The most difficulties arise when your projection includes one of the poles or the 180 degree meridian.  Then you nearly always run into issues resulting in artefacts of some kind that require some more work than just setting the projection in your software.</p><p>And finally when you are advocating Mercator keep in mind that you cannot show the whole world in Mercator, web maps are cut off at 85 degrees and are often unusable beyond about 75 degrees since map styling is way off with regards to scale then.  This does not mean it cannot work great for other parts of the planet of course.  But while for lower latitudes use of other projections is just often better and nicer for polar regions it is essential.</p></blockquote>","contentSnippet":"Using open source tools it is now super easy to make your own map tiles, and with a little extra work you can render them in whatever map projection you want. No more excuses to use Mercator! For example, here is a map we published today at The Upshot. It shows where prime-age women are working more or less then average, and includes data from county-level in the overview map down to every census tract once you zoom in. And all is nicely projected in Albers Equal-Area Conic, a projection widely adopted as standard for U.S. maps.\n\n\n\n# So how does this work?\nAfter many years of blindly accepting the dominance of Web Mercator tile maps, I was quite surprised to learn how easy it is to use whatever projection you want. So how does this work? The answer is that it works because Mapnik, the core of many open source tile mapping frameworks, supports custom projections out of the box. It is just the tools built around Mapnik that are not supporting other projections. Tilemill, for instance, is a super nice tool for styling map tiles in a CSS like language. But if you export your map as tiles using Tilemill, you are stuck with Web Mercator, even though internally it is Mapnik that renders all the tiles. Fortunately this doesn‚Äôt mean that you have to deal with Mapnik and it‚Äôs quirks directly to get custom projections.\n# Step 1: Export Mapnik XML and change projection\nSo the first step is to style your map just as you would with a Mercator map, enjoying the full feature-set of Tilemill. Once you‚Äôrd done with that you export your project as Mapnik XML. Think of this XML file as the entire description of your map. It contains all the references to the source layers and all the styles for the map features ‚Äì in one single file. If you actually read the code of the file you will quickly realize how extremely lucky we are to have Tilemill and CartoCSS. And you might also notice that in the root element of the document, named <Map>, you find the the definition of the map projection as Proj.4 string in the srs attribute (for spatial reference system). And you can simply change it to whatever you want. In this case I replaced the Mercator projection with the Albers projection (copied from the Proj.4 definition linked here):\n\n\n1\n2\n3\n4\n\n<Map srs=\"+proj=aea +lat_1=29.5 +lat_2=45.5\n   +lat_0=37.5 +lon_0=-96 +x_0=0 +y_0=0 +ellps=sphere\n   +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +nadgrids=@null\"\n   background-color=\"#ffffff\">\n\n\nI copied the Proj.4 string from spatialreference.org, where you find many other standard projections as well. (Hint: If you plan on aligning the tile map to a D3.js projected vector overlay you should append +nadgrids=@null to the Proj.4 string) To preview the projection I used TileStache. All it needs is a JSON configuration file that points to the exported Mapnik XML as input layer.\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n{\n    \"cache\": {\n        \"name\": \"Disk\", \"path\": \"tiles\"\n    },\n    \"layers\": {\n        \"map\": {\n            \"provider\": {\"name\": \"mapnik\", \"mapfile\": \"mapnik.xml\"},\n            \"projection\": \"spherical mercator\"\n        }\n    }\n}\n\n\nThen you run tilestache-server.py with your config and open http://localhost:8080/map/preview.html to preview the freshly rendered projected tiles, just as you would in Tilemill.\n# Step 2: Figuring out which tiles to render\nNow we come to the first tricky part of the process. We need to figure out which tiles we actually want to be rendered. You probably already know the zoom levels and the bounding box in WGS 84 lat/lon coordinates, but the latter won‚Äôt help us much since TileStache is designed for rectangular projections like Mercator. Fortunately TileStache also takes a text file with a list of Z/X/Y tile coordinates as input. To get this list of tiles I wrote a Python script (feel free to re-use if you want). The script uses mercantile, a Python library for tile calculations, which returns the tile coordinates for points in WGS84 lat/lon, assuming that the tiles are projected in Web Mercator. To trick the library into giving me the correct tiles, I converted the points to the custom projection first and then projected them ‚Äúback‚Äù from Web Mercator (even though the coordinates aren‚Äôt in Mercator). When mercantile gets my ‚Äúfake‚Äù lat/lon coordinates it projects them to Mercator (reversing my inverse projection) and ends up with the Albers Equal Area coordinates.\n\n\n1\n2\n3\n4\n5\n6\n\ndef get_tile(lon, lat, z):\n    # project to custom projection\n    pt = albers(lon, lat)\n    # project \"back\" from Mercator\n    pt2 = mercator(pt[0], pt[1], inverse=True)\n    return mercantile.tile(pt2[0],pt2[1], z)\n\n\nUsing this function I then compute the top-left and bottom-right tile for each zoom level and add every tile in between the two to my tile list.  The bounding box coordinates deserve a further note. Bounding boxes cannot be projected between non-rectangular coordinate systems. Here is an example showing a lat/lon bounding box that works fine in Mercator, projected to the Albers projection. Not only do we get too much empty space but we‚Äôre also missing significant parts of U.S. territory.  So instead we have to do the reverse approach and grab the Albers bounding box and then project it back to WGS 84 lat/lon (I used QGIS for this step). This bounding box I then used in the Python script to generate the tile urls.  Finally we run tilestache-seed.py to pre-generate all the tiles in our list (you probably want to host them as static files somewhere), which may or may not take quite a while to finish.\n\n\n1\n2\n\npython make-tile-urls.py\ntilestache-seed.py -c config.json --tile-list=tile-urls.txt --layer=map\n\n\n# Step 3: Translating coordinates in web map\nOnce we generated all our tiles we almost made it to the end. The tiles can be used just like Mercator tiles, so you are free to pick your favorite tilemap framework such as Leaflet.js, Polymaps, OpenLayers or whatever you prefer. For our women employment map I went with ModestMaps which I like for its simplicity and ‚Äúhackability‚Äù. However, all of these frameworks assume that your tiles are in Mercator projection, so the built-in conversion from WGS 84 lat/lon to Mercator tile coordinates won‚Äôt work for us ‚Äì unless we do the same trick I showed above. First, we are going to need the two projections Web Mercator and Albers, which you find in the Proj.4 JavaScript fork. Needless to say that you should use the exact same projection definition here.\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n// Web Mercator\nvar mercator = proj4('+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 '\n               + '+x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext '\n               + '+over +no_defs'),\n    // Albers Equal Area\n    albers = proj4('+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=37.5 +lon_0=-96 '\n              + '+x_0=0 +y_0=0 +ellps=sphere +nadgrids=@null '\n              + '+towgs84=0,0,0,0,0,0,0 +units=m +no_defs');\n\n\nUsing these projection classes we can convert coordinates from the ‚Äòreal‚Äô WGS 84 lat/lon coordinates to the ‚Äòwrong‚Äô lat/lon coordinates on our map, by first projecting to Albers, and then inverse projecting ‚Äúback‚Äù from Web Mercator.\n\n\n1\n2\n3\n4\n\nfunction WGS84ToMap(pt) {\n    pt = mercator.inverse(albers.forward([pt.lon, pt.lat]));\n    return { lon: pt[0], lat: pt[1] };\n}\n\n\nThe same works in the reverse direction, too. I used this to display the current map coordinates in the URL hash, simply by passing the map center (the ‚Äòwrong‚Äô coordinates I get from map.getCenter()) to mapToWGS84().\n\n\n1\n2\n3\n4\n\nfunction mapToWGS84(pt) {\n    pt = albers.inverse(mercator.forward([pt.lon, pt.lat]));\n    return { lon: pt[0], lat: pt[1] };\n}\n\n\nAnd that‚Äôs basically all it needed to get the tile map library working with my custom projected tiles. Of course there is a lot more I could write about (and I will in future posts), but for now, let‚Äôs wrap this up: Making tile maps using custom projections isn‚Äôt that hard, and the beautiful maps are definitely worth it. You can use Tilemill just as usual, export Mapnik XML, change the projection in the XML and then render the tiles using TileStache. You can use these tiles in any tile map framework, but you have to convert coordinates from and to your ‚Äòwrong‚Äô lat/lons. If you have further questions or know a different approach for tile maps in custom projections, let us know in the comment section. Also, if you happen to work at Mapbox or another company that produces tile map tools with a built-in limitation to rectangular projections, I would be curious to hear why you‚Äôre not willing to go the extra mile for the sake of beautiful maps. And in case you find this blog post helpful, please tweet it! üòÉ\n# Comments\nHannes (Jan 07, 2015)\n\nYou should be able to find lots of software in/from the geo world, rather than the JS world, that was designed with support for any projection in mind. OpenLayers can handle any projection, there also is a Proj4 plugin for Leaflet. There are standards like TMS or WMS variants. This might make it all easier and less ‚Äúthrough the backdoor‚Äù. üòâ\nSeeing web mercator being used for everything, just because some software dictated or suggested it, is painful for people with a cartographic background.\n\nGregor (Jan 07, 2015)\n\nIndeed. I saw that OpenLayers can deal with projections and that there is a Leaflet Plugin for Proj4. I guess I partly wrote this post to convince maintainers of Mercator-bound geo software to consider adding support for custom projected tiles. The coordinate transformation should really be part of the frameworks,  and not of the map code.\n\nCalvin (Jan 07, 2015)\n\nJason Davies‚Äô work on projected tiles is pretty good and avoids the pitfall your solution has which is interoperability, the reason for using mercator tiles is because thats that the other tiles are in and for most maps it‚Äôs good enough.\n\nGregor (Jan 07, 2015)\n\nYeah, I know his work on projected tiles. It‚Äôs a nice trick, but it wouldn‚Äôt work in a real use case as the map labels get rotated and look blurry. You want crisp and horizontally aligned text on a map, right?\n\ns (Jan 07, 2015)\n\nWhy not simply use a d3 projection for your project? I see no need for tiles.\n\nGregor (Jan 07, 2015)\n\nHa, I‚Äôm curious to hear how you would render this detail view of NYC just using D3.\nhttp://new.tinygrab.com/f3aa221ede71c30897f1a0998015ed988375dffdfc.png\nAt the very least you would need vector tiles instead of image tiles, since the streets alone are several gigabytes.\n\nSteven Romalewski (Jan 08, 2015)\n\nThis is a helpful post.  But following on Calvin‚Äôs comment, hasn‚Äôt the sole reason for using the Web Mercator projection been so you can overlay tiles on now-ubiquitous basemaps such as Google‚Äôs?\nI agree that we shouldn‚Äôt ‚Äúblindly accept‚Äù the web Mercator projection, but there‚Äôs a reason for it, whether it‚Äôs a good reason or not.  I thought it would have made your post stronger if you had stated that obvious but perhaps overlooked point.\nIn other words, it wasn‚Äôt like we all just woke up yesterday and realized that we should be making maps in other projections.  There are thousands of map projections/coordinate systems that have been used for decades (centuries?), each with a particular purpose and/or location in mind.\nBut if you want to easily overlay your choropleth or other map layers on a pre-rendered basemap, for now there‚Äôs Google, Bing, MapQuest, and OSM and its variants.  And those are all web Mercator.\nNoticeably the Times‚Äôs map in your blog post (which is very nice, btw) does not have much of a basemap other than neighborhood labels and streets.  True, you could argue that it doesn‚Äôt need any more than that.  But for now, if you don‚Äôt use web Mercator, you can‚Äôt use an ‚Äúoff-the-shelf‚Äù basemap - you‚Äôd need to create your own in the same custom projection, not necessarily a trivial task.\nAnyway, you‚Äôre right that ‚Äúmaking tile maps using custom projections‚Äù isn‚Äôt complicated. But I thought the reason why we‚Äôve all been using web Mercator should‚Äôve been pointed out.  And it‚Äôd be nice if we could overlay non-web Mercator tiles on the now-standard basemaps (or, better yet, reproject those pre-rendered basemaps on the fly).  But maybe not being able to do that is (one of) the price(s) we‚Äôve been paying for these otherwise ‚Äúfree‚Äù services.\n\nTom (Jan 08, 2015)\n\nOkay, I‚Äôll bite.\nReasons why Mapbox doesn‚Äôt support non-Mercator projections (yet):\nProjection definitions are stuck in the 80s: you have to look up some string defining a projection and copy and paste it from place to place, or rely on a shorthand to that string and hope that it‚Äôs the right shorthand and you have the right CSV of projections stashed somewhere on your computer.\nThis is a fixable problem, but currently no-one has the technical and political skills to do it as well as a good reason to spend a lot of time on it.\nNext: ‚Äúcompatibility over the internet‚Äù: the sort of problem for which other technology has the html ‚Äòlang‚Äô attribute and magic numbers in binary files and so on. There is nothing for this: having Leaflet know what projection a layer is in, without copying and pasting JavaScript or some hopefully-accurate proj4 string is just not a reality.\nWhich brings us to the user expectation that layered maps should work. Back in the day, I worked with OpenLayers, which offered glorious projection support: really, it had gone all-in on making everything projection-related possible, though not easy. And this was the cause of a tremendous percentage of all support: it is a reasonable expectation that you can combine map layers of different projections and it‚Äôll work, but it can‚Äôt. Tiles are baked images and they are baked in projections, never to be warped without significant artifacting (see MapProxy).\nSo, metadata doesn‚Äôt exist, user expectations are not set, finally tiling. Virtually all tiled sources use the OSM ‚ÄúXYZ‚Äù tiling scheme, which is only defined for Spherical Mercator and, for each other projection, is a big question mark. Schemes that try to resolve this, like WMTS, have fallen into the overstandardized complexity gotcha, with each projection also having sort of meta-choices around exactly where you want to slice and how. They‚Äôre too big to be popular, when XYZ tiles are so simple a novice coder can write a tiling client.\nWhich brings us to vector tiles. The popular conception of vector tiles is that they‚Äôre ‚Äújust vector data‚Äù and thus all further choices are free. Unfortunately, this isn‚Äôt true: vector tiles are tiles, and to be efficient they need to be simplified. An efficient simplification is perceptual, so they‚Äôre simplified to the tiling scheme, which is - you guessed it - Spherical Mercator. A bummer, but the upside is that dynamic reprojection of vector tiles has radically less distortion than reprojection of raster tiles, so it is a big win.\nI hope this clears up some of the rationale for why this isn‚Äôt easy to do technically. I‚Äôll close with two quick non-technical notes:\nFirstly: demand for non-Mercator projections is a high-level user request from people who are really into cartography. Projections are invisible for the vast majority of developers, designers, and consumers. And for people who are into cartography but also need a different dimension - like tons of data or easy compatibility with non-Leaflet APIs - the complexity disadvantages of custom projections outweigh the wins, fast.\nThe problem here is that, while this was doable for you, it consisted of four technical steps that all have decisions baked in - decisions that you can make and you can accept at each level. You made the map, you know it‚Äôs in a projection, you can configure Leaflet and know that it isn‚Äôt going to work with a different tile layer, or a map you make in a different projection. The problem that a larger system (eg Mapbox) would have to solve is to make a general solution for each of these steps, as well as all of the bumpers to make this less of a usability nightmare: how do you use this map in iOS? In GL? If you have related information to geocode from, is the vector tile data projected as well? Or not projected, in a separate tileset?\n\nPaul Ramsey (Jan 08, 2015)\n\nAgree w/ everything except the metadata argument at the top. OGC WKT for SRS is ‚Äúgood enough‚Äù to represent all kinds of projections in a nice standard way, and even includes niceties like spheroid/datum handling (which proj is more flakey about). And handling it is a solved problem. Death to ESPG codes.\n\nMatthew (Jan 08, 2015)\n\nThe cartographic argument for non-Mercator maps is compelling - I too like looking at maps in other projections - but I think it‚Äôs a fair point that, if all you‚Äôre doing is plotting some data on a map, the interop advantages to Mercator are worth the compromise.\n> Projections are invisible for the vast majority of developers‚Ä¶\nFor anything beyond simply dumping your data on a map, that‚Äôs precisely the problem. Sweeping the complexity of projections under the rug and saying ‚Äúlook how easy this is now‚Äù is not a solution. Projections fundamentally alter the results of geospatial analyses; they are a necessary and fundamental core concept, an absolute prerequisite to doing anything with geographic data.\nAny analysis with spatial relationships, area, distance, direction and geometric overlays are compromised if you are working in the wrong projection.  I can‚Äôt wait to see what stupid mistakes arise ‚Äúdoing GIS‚Äù in javascript without consideration for projections.\n\nTom (Jan 08, 2015)\n\nThis is a discussion of output in projections for display. This is entirely separate to how data is stored, or in which projection it is processed - I don‚Äôt see how jabs at ‚ÄòGIS in JavaScript‚Äô are relevant. Nobody stores their raw data in ‚Äòmercator‚Äô and nobody‚Äôs suggesting that.\n\nMatthew (Jan 08, 2015)\n\nYeah sorry, the jab at ‚ÄúGIS in Javascript‚Äù was unnecessary. It‚Äôs more a jab at the general idea that you can do anything significant with geographic data without consideration for projections. You can‚Äôt sweep it under the rug: projections have real implications for storing, analyzing and displaying any geographic data. The ‚Äúit doesn‚Äôt matter, just use Mercator‚Äù approach is not ultimately helpful to the geospatial developer community.\n\nGregor (Jan 08, 2015)\n\nBtw, Mike just pointed me to this demonstration of streets rendered from vector tiles in D3: http://bl.ocks.org/mbostock/5593150\n\nTom (Jan 08, 2015)\n\nThen we‚Äôre in agreement: it is extremely important to know about geographic data in depth if you‚Äôre going to analyze it. The difference between projections in data and in output is important: nobody‚Äôs should do their analysis in web mercator. The output of their analysis on a web mercator map is a totally different concern.\nAnd I don‚Äôt mean to belittle projections in general: they are useful and interesting, and for some analysis, mercator really doesn‚Äôt cut it (mostly for the arctic). I think in a lot of cases, mercator does cut it: a person doing a scaled-point map in their small American city shouldn‚Äôt spend an hour choosing their projection, just like you shouldn‚Äôt spend a bunch of time choosing fonts in your school essays: that‚Äôs a distraction.\nBut it is important to understand why mercator is the default in so many places and the technical issues surrounding it. That‚Äôs the only way we can really grasp what‚Äôs on the todo list to make custom output projections less of a technical gotcha.\n\nGregor (Jan 08, 2015)\n\nTom, thanks so much for helping us to understand this.\nI agree, once you‚Äôre at the point where you want to combine different map layers you get into big trouble. And while I can see why Mapbox is not investing more resources into this feature, there are still a few (simple) things that could significantly help making custom projected tiles in Tilemill:\n\nAllowing to set the projection per project and simply passing it on to Mapnik. If I can preview maps in custom projections easily in TileStache, this should work in Tilemill, too. This could be a feature marked as ‚Äòexperimental‚Äô with big warning signs to keep away less ‚Äòhigh-level‚Äô users.\nIt would be nice if Tilemill could export separate Mapnik XML styles for Retina tiles.  I found a way to do this using a global @scale variable to rescale line withs and font sizes, and shifting the zoom level.\nFinally, Tilemill could also allow exporting tiles in custom projection, essentially just by letting Mapnik do it‚Äôs job. Then end-users like me would not need to use TileStache.\n\nMaybe I try hacking this into Tilemill one day‚Ä¶\n\nBill (Jan 08, 2015)\n\nGregor, I‚Äôm probably oversimplifying for your specific use case, but I‚Äôve always found it easy enough to use custom projections in Tilemill without resorting to the Mapnik XML or a custom tile server. By lying to Tilemill when loading layers (‚ÄúWhy yes, computer friend, this shapefile IS in EPSG:900913!‚Äù), you can render in Albers US, then bake the tiles to mapbox hosting or chop them up with mbutil for static serving. The only downside is the obviously-incorrect internal geolocation (note the hash).\n\nFriedrich Hartmann (Jan 09, 2015)\n\nFirst I want to point out that Spherical Mercator still excels for global coverage of raster data to be viewed at small scales (street level to region) due to it‚Äôs conformal properties. It‚Äôs just ill-suited for continental to global map view extents.\nAnd since, in the past, clients were only meant to stitch image tiles back together the tiling was inherently linked to the map projection since all the labels were already baked in and distorting them by means of reprojection simply would make things look not as nice as they should be.\nThis problem and limitation is avoidable in client side rendering of vector data as stated here before, the hard dependency between the geo data‚Äôs coordinate system and the displayed map projection is not in existence anymore.  So why keep the old tiling schemes? Projection definitions are definitely not the problem here, neither are they stuck in the 80‚Äôs nor are they inherently hard to understand, especially the so called geometric projections. Also there is the need to be made a distinction between the data‚Äôs geographic coordinate system and Datum (WGS84, NAD83) and projected coordinate systems like UTM called coordinate reference systems (CRS), these all are different beast. The part that is responsible for the complexity of the CRS string is not the projection it‚Äôs the arbitrary definition of the different coordinate systems and the transformation between them.\nI see it as eventually inevitable to adopt a better tiling scheme for global vector data than an equirectangular or Mercator grid. They both have at least some major drawbacks, compared to better suited hierarchical geodesic grids. One is being not equal area, which means an uneven number of calls and different amount of area coverage per tile based on latitude of the tile at the same scale. Where the equirectangular grid merely has two singularities,  the spherical Mercator square has no coverage at all, at the poles beyond 85¬∞, which disqualifies it as a global all purpose tiling scheme all together. An improvement would be to replace the usual rectangular data tiling with something more appropriate for the type of data we‚Äôre dealing with here, which are in the end points on an ellipsoid or sphere; in most cases a sphere will do.\nThere exist some not too complex alternatives like the Icosahedron Snyder Equal Area (ISEA) grid or HEALPix, which is well established and has quite solid support and libraries around it in the astronomical community (check out TPZF/GlobWeb on GitHub). Another benefit of having an equal area grid is being able to make statistical comparison between tiles on the same hierarchy level, like nodes per km¬≤, which is not dorictly possible in the current grids used for vector map tiles.\nDoing the server side generalization within the projected CRS of the geodesic grid tiles would further harmonize the level of generalization across the globe, generalizing in equirectangular Cartesian space is a bad idea to begin with.\nTo sum up, I strongly recommend adopting a geodesic grid based tiling scheme for vector based maps.\n\nAaron Dennis (Jan 09, 2015)\n\nI hate looking at the whole US in web mercator, too, but I find it equally unattractive to see zoomed in versions of the states on the east and west coasts that are tilted because the central meridian of their Albers projection is a thousand miles away.\nBeyond interoperability with other web maps, Mercator is actually great at preserving local angles. If you want a map that let‚Äôs you zoom to any place and scale in the country, Mercator might be the best choice.\nIt seems the solution might be vector tiles projected ‚Äúon the fly.‚Äù We‚Äôll probably get there, but Mercator does okay for now.\n\nGregor (Jan 09, 2015)\n\nI could hold against your argument that (1) the idea of North direction showing up is a rather artificial concept anyway and that (2) this wouldn‚Äôt be the first map where North is not showing up and also that (3) North being exactly up isn‚Äôt a really important feature of a map unless you looking for shortest way to the North pole ‚Äî but still I can see your point. Especially when you look at Alaska and Hawaii, which are shown equal-area but ‚Äòrotated‚Äô to an unfortunate degree.\nStill better than Mercator in the full U.S. view. Guess next time I switch from Albers to Mercator tiles at some zoom level.\n\nFriedrich Hartmann (Jan 10, 2015)\n\nAlbers also preservers angles within and around it‚Äôs standard parallels very well. And Lambert conformal conic projection even preserves them everywhere. It‚Äôs basically the same as Mercator but using a cylinder as projective Surface.\nFor interactive maps there is even the possibility to have dynamic projection parameters based on the active view scale. While this is hard to realize for raster tile maps (no smooth transitions feasible due to fixed number of zoom scales), it‚Äôs quite realistic to do this for vector based ones. Continental view would be Lambert, as you zoom in it‚Äôs being gradually transitioned into Mercator, by interpolating between the two projections, this way it‚Äôs even directly compatible with raster tiles on higher zoom levels.\nhttp://cartography.oregonstate.edu/ScaleAdaptiveWebMapProjections.html\n\nJamie Robertson (Mar 20, 2015)\n\nGreat Post! I‚Äôve been working on my own tiles and they are working great in the tilestache previewer. I‚Äôm struggling with getting the last few functions you noted in step 3 to work with leaflet. Do you happen to have some example code for that, or with modestmaps? Thanks!\n\nChris (Jan 16, 2015)\n\nSaw this a bit late but thought i‚Äôd add a few notes that might be helpful to those who want to try using different projections in web maps.\nAs others have already hinted for a zoomable map in conic projection Lambert is probably a better choice than Albers, for a whole country map showing statistical quantities the equal-area property might be considered more important of course.\nThe most difficulties arise when your projection includes one of the poles or the 180 degree meridian.  Then you nearly always run into issues resulting in artefacts of some kind that require some more work than just setting the projection in your software.\nAnd finally when you are advocating Mercator keep in mind that you cannot show the whole world in Mercator, web maps are cut off at 85 degrees and are often unusable beyond about 75 degrees since map styling is way off with regards to scale then.  This does not mean it cannot work great for other parts of the planet of course.  But while for lower latitudes use of other projections is just often better and nicer for polar regions it is essential.","summary":"<p>Using open source tools it is now super easy to make your own map tiles, and with a little extra work you can render them in whatever map","id":"https://vis4.net/blog/2015/01/no-more-mercator-tiles/","isoDate":"2015-01-06T20:06:32.000Z","blogTitle":"vis4.net"}},"__N_SSG":true}